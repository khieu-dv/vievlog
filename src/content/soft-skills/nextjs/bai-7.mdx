# BÃ i 7: Advanced Routing Patterns trong Next.js App Router

<div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border-l-4 border-blue-500 mb-8">
  <h2 className="text-2xl font-bold text-blue-800 mb-2">ğŸ¯ Má»¥c tiÃªu bÃ i há»c</h2>
  <p className="text-gray-700">Trong bÃ i há»c nÃ y, chÃºng ta sáº½ tÃ¬m hiá»ƒu vá» cÃ¡c máº«u routing nÃ¢ng cao trong Next.js App Router, bao gá»“m Parallel Routes, Intercepting Routes, Route Groups vÃ  cÃ¡c ká»¹ thuáº­t báº£o máº­t routes.</p>
</div>

## ğŸ“‹ Ná»™i dung chÃ­nh

| Chá»§ Ä‘á» | Thá»i gian | Äá»™ khÃ³ |
|--------|-----------|---------|
| Parallel Routes | 45 phÃºt | â­â­â­ |
| Intercepting Routes | 40 phÃºt | â­â­â­â­ |
| Route Groups | 30 phÃºt | â­â­ |
| Middleware & Route Protection | 50 phÃºt | â­â­â­â­ |
| Redirects & Rewrites | 35 phÃºt | â­â­â­ |

---

## 1. Parallel Routes - Äá»‹nh tuyáº¿n song song

### ğŸ” KhÃ¡i niá»‡m cá»‘t lÃµi

**Parallel Routes** cho phÃ©p báº¡n hiá»ƒn thá»‹ nhiá»u trang Ä‘á»“ng thá»i trong cÃ¹ng má»™t layout. Äiá»u nÃ y Ä‘áº·c biá»‡t há»¯u Ã­ch khi xÃ¢y dá»±ng dashboard, modal hoáº·c cÃ¡c giao diá»‡n phá»©c táº¡p.

```mermaid
graph TD
    A[Layout Root] --> B[Dashboard]
    A --> C[Analytics] 
    A --> D[Notifications]
    B --> E[Dashboard Content]
    C --> F[Analytics Content]
    D --> G[Notifications Panel]
```

### ğŸ“ Cáº¥u trÃºc thÆ° má»¥c cho Parallel Routes

```
app/
â”œâ”€â”€ layout.tsx
â”œâ”€â”€ page.tsx
â”œâ”€â”€ @dashboard/
â”‚   â”œâ”€â”€ page.tsx
â”‚   â””â”€â”€ loading.tsx
â”œâ”€â”€ @analytics/
â”‚   â”œâ”€â”€ page.tsx
â”‚   â””â”€â”€ error.tsx
â””â”€â”€ @notifications/
    â”œâ”€â”€ page.tsx
    â””â”€â”€ default.tsx
```

<div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
  <h4 className="text-yellow-800 font-semibold mb-2">âš ï¸ LÆ°u Ã½ quan trá»ng</h4>
  <p className="text-yellow-700">TÃªn thÆ° má»¥c báº¯t Ä‘áº§u vá»›i <code>@</code> Ä‘Æ°á»£c gá»i lÃ  <strong>slot</strong>. ChÃºng khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n URL routing.</p>
</div>

### ğŸ’» Triá»ƒn khai Parallel Routes

#### Layout chÃ­nh (app/layout.tsx)
```tsx
export default function RootLayout({
  children,
  dashboard,
  analytics,
  notifications,
}: {
  children: React.ReactNode
  dashboard: React.ReactNode
  analytics: React.ReactNode
  notifications: React.ReactNode
}) {
  return (
    <html lang="en">
      <body className="min-h-screen bg-gray-50">
        <nav className="bg-white shadow-sm border-b px-6 py-4">
          <h1 className="text-xl font-semibold">Admin Dashboard</h1>
        </nav>
        
        <div className="container mx-auto p-6">
          <div className="grid grid-cols-12 gap-6">
            {/* Main content */}
            <div className="col-span-8">
              {children}
            </div>
            
            {/* Sidebar with parallel routes */}
            <div className="col-span-4 space-y-6">
              <div className="bg-white rounded-lg shadow p-4">
                {dashboard}
              </div>
              
              <div className="bg-white rounded-lg shadow p-4">
                {analytics}
              </div>
              
              <div className="bg-white rounded-lg shadow p-4">
                {notifications}
              </div>
            </div>
          </div>
        </div>
      </body>
    </html>
  )
}
```

#### Dashboard slot (@dashboard/page.tsx)
```tsx
export default function DashboardSlot() {
  return (
    <div className="space-y-4">
      <h2 className="text-lg font-semibold text-gray-800">
        Quick Stats
      </h2>
      <div className="grid grid-cols-2 gap-3">
        <div className="bg-blue-50 p-3 rounded">
          <div className="text-2xl font-bold text-blue-600">1,234</div>
          <div className="text-sm text-gray-600">Total Users</div>
        </div>
        <div className="bg-green-50 p-3 rounded">
          <div className="text-2xl font-bold text-green-600">$45,678</div>
          <div className="text-sm text-gray-600">Revenue</div>
        </div>
      </div>
    </div>
  )
}
```

### ğŸ“Š Báº£ng so sÃ¡nh Parallel Routes vs Traditional Routing

| TiÃªu chÃ­ | Parallel Routes | Traditional Routing |
|----------|-----------------|-------------------|
| **Hiá»ƒn thá»‹ Ä‘á»“ng thá»i** | âœ… Nhiá»u component cÃ¹ng lÃºc | âŒ Chá»‰ má»™t route táº¡i má»™t thá»i Ä‘iá»ƒm |
| **Performance** | âš¡ Táº£i song song, tá»‘c Ä‘á»™ cao | ğŸŒ Táº£i tuáº§n tá»± |
| **Code Organization** | ğŸ“ TÃ¡ch biá»‡t theo chá»©c nÄƒng | ğŸ“„ Táº­p trung vÃ o má»™t file |
| **Complexity** | ğŸ”¥ Phá»©c táº¡p hÆ¡n | â­ ÄÆ¡n giáº£n |
| **Use Cases** | Dashboard, Modal, Layout phá»©c táº¡p | Trang Ä‘Æ¡n giáº£n |

---

## 2. Intercepting Routes - Cháº·n Ä‘á»‹nh tuyáº¿n

### ğŸ¯ KhÃ¡i niá»‡m vÃ  á»©ng dá»¥ng

**Intercepting Routes** cho phÃ©p báº¡n "cháº·n" má»™t route vÃ  hiá»ƒn thá»‹ ná»™i dung khÃ¡c, thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ táº¡o modal, overlay hoáº·c preview.

```mermaid
flowchart LR
    A[User clicks /photo/123] --> B{Route Intercepted?}
    B -->|Yes| C[Show Modal]
    B -->|No| D[Show Full Page]
    C --> E[Background: Current page]
    D --> F[Navigate to new page]
```

### ğŸ“‚ CÃº phÃ¡p Intercepting Routes

| CÃº phÃ¡p | MÃ´ táº£ | VÃ­ dá»¥ |
|---------|-------|-------|
| `(.)` | CÃ¹ng cáº¥p | `(.)/photo/[id]` |
| `(..)` | Cáº¥p cha | `(..)/photo/[id]` |
| `(...)` | Tá»« root | `(...)/photo/[id]` |
| `(..)(..)` | Hai cáº¥p trÃªn | `(..)(..))/photo/[id]` |

### ğŸ—ï¸ XÃ¢y dá»±ng Modal vá»›i Intercepting Routes

#### Cáº¥u trÃºc thÆ° má»¥c
```
app/
â”œâ”€â”€ layout.tsx
â”œâ”€â”€ page.tsx
â”œâ”€â”€ @modal/
â”‚   â”œâ”€â”€ (.)photo/
â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â””â”€â”€ default.tsx
â”œâ”€â”€ photo/
â”‚   â””â”€â”€ [id]/
â”‚       â””â”€â”€ page.tsx
â””â”€â”€ components/
    â””â”€â”€ modal.tsx
```

#### Modal Component (components/modal.tsx)
```tsx
'use client'

import { useRouter } from 'next/navigation'
import { useEffect, useRef } from 'react'

interface ModalProps {
  children: React.ReactNode
}

export default function Modal({ children }: ModalProps) {
  const router = useRouter()
  const dialogRef = useRef<HTMLDialogElement>(null)

  useEffect(() => {
    dialogRef.current?.showModal()
  }, [])

  const handleClose = () => {
    router.back()
  }

  return (
    <dialog
      ref={dialogRef}
      className="fixed inset-0 z-50 bg-black bg-opacity-50 backdrop-blur-sm"
      onClose={handleClose}
    >
      <div className="flex items-center justify-center min-h-screen p-4">
        <div className="bg-white rounded-lg shadow-xl max-w-lg w-full">
          <div className="flex justify-end p-2">
            <button
              onClick={handleClose}
              className="text-gray-500 hover:text-gray-700 text-2xl"
            >
              Ã—
            </button>
          </div>
          <div className="px-6 pb-6">
            {children}
          </div>
        </div>
      </div>
    </dialog>
  )
}
```

#### Intercepted Route (@modal/(.)photo/[id]/page.tsx)
```tsx
import Modal from '@/components/modal'
import { getPhotoById } from '@/lib/api'

interface Props {
  params: { id: string }
}

export default async function PhotoModal({ params }: Props) {
  const photo = await getPhotoById(params.id)

  return (
    <Modal>
      <div className="space-y-4">
        <h2 className="text-xl font-semibold">{photo.title}</h2>
        <img
          src={photo.url}
          alt={photo.title}
          className="w-full h-64 object-cover rounded-lg"
        />
        <p className="text-gray-600">{photo.description}</p>
        
        <div className="flex space-x-2">
          <span className="px-2 py-1 bg-blue-100 text-blue-800 text-sm rounded">
            {photo.category}
          </span>
          <span className="px-2 py-1 bg-gray-100 text-gray-800 text-sm rounded">
            {photo.author}
          </span>
        </div>
      </div>
    </Modal>
  )
}
```

---

## 3. Route Groups - NhÃ³m Ä‘á»‹nh tuyáº¿n

### ğŸ“ KhÃ¡i niá»‡m Route Groups

**Route Groups** cho phÃ©p tá»• chá»©c routes mÃ  khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n URL path. Sá»­ dá»¥ng cÃº phÃ¡p `(groupName)`.

<div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
  <h4 className="text-green-800 font-semibold mb-2">ğŸ’¡ Lá»£i Ã­ch cá»§a Route Groups</h4>
  <ul className="text-green-700 space-y-1">
    <li>â€¢ Tá»• chá»©c code theo chá»©c nÄƒng</li>
    <li>â€¢ Táº¡o multiple root layouts</li>
    <li>â€¢ KhÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n URL routing</li>
    <li>â€¢ Dá»… dÃ ng quáº£n lÃ½ large applications</li>
  </ul>
</div>

### ğŸ¢ VÃ­ dá»¥ thá»±c táº¿: E-commerce Site

```
app/
â”œâ”€â”€ (shop)/
â”‚   â”œâ”€â”€ layout.tsx          # Shop layout
â”‚   â”œâ”€â”€ page.tsx            # Homepage (/)
â”‚   â”œâ”€â”€ products/
â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚       â””â”€â”€ page.tsx    # /products/123
â”‚   â””â”€â”€ cart/
â”‚       â””â”€â”€ page.tsx        # /cart
â”œâ”€â”€ (admin)/
â”‚   â”œâ”€â”€ layout.tsx          # Admin layout  
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â””â”€â”€ page.tsx        # /dashboard
â”‚   â””â”€â”€ users/
â”‚       â””â”€â”€ page.tsx        # /users
â””â”€â”€ (auth)/
    â”œâ”€â”€ login/
    â”‚   â””â”€â”€ page.tsx        # /login
    â””â”€â”€ register/
        â””â”€â”€ page.tsx        # /register
```

#### Shop Layout ((shop)/layout.tsx)
```tsx
import Header from '@/components/shop/header'
import Footer from '@/components/shop/footer'

export default function ShopLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="min-h-screen flex flex-col">
      <Header />
      <main className="flex-1 container mx-auto px-4 py-8">
        {children}
      </main>
      <Footer />
    </div>
  )
}
```

#### Admin Layout ((admin)/layout.tsx)
```tsx
import AdminSidebar from '@/components/admin/sidebar'
import AdminHeader from '@/components/admin/header'

export default function AdminLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="flex h-screen bg-gray-100">
      <AdminSidebar />
      <div className="flex-1 flex flex-col overflow-hidden">
        <AdminHeader />
        <main className="flex-1 overflow-auto p-6">
          {children}
        </main>
      </div>
    </div>
  )
}
```

### ğŸ“Š Mapping Route Groups Usage

| Use Case | Structure | Benefit |
|----------|-----------|---------|
| **Multi-tenant App** | `(tenant1)`, `(tenant2)` | Separate layouts per tenant |
| **User Roles** | `(admin)`, `(user)`, `(guest)` | Role-based layouts |
| **Features** | `(blog)`, `(shop)`, `(docs)` | Feature-based organization |
| **Localization** | `(en)`, `(vi)`, `(fr)` | Language-specific layouts |

---

## 4. Middleware vÃ  Route Protection

### ğŸ›¡ï¸ Giá»›i thiá»‡u Middleware

**Middleware** trong Next.js cháº¡y trÆ°á»›c khi request Ä‘Æ°á»£c hoÃ n táº¥t, cho phÃ©p báº¡n modify response, redirect, rewrite hoáº·c set headers.

```mermaid
sequenceDiagram
    participant User
    participant Middleware
    participant Route
    participant Response

    User->>Middleware: Request /protected
    Middleware->>Middleware: Check Authentication
    alt Authenticated
        Middleware->>Route: Allow Request
        Route->>Response: Generate Response
        Response->>User: Return Content
    else Not Authenticated
        Middleware->>User: Redirect to /login
    end
```

### âš™ï¸ Thiáº¿t láº­p Middleware

#### middleware.ts (root level)
```tsx
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  // Get token from cookies
  const token = request.cookies.get('auth-token')
  const isLoginPage = request.nextUrl.pathname.startsWith('/login')
  const isAdminPage = request.nextUrl.pathname.startsWith('/admin')
  const isApiRoute = request.nextUrl.pathname.startsWith('/api')

  // Redirect logic
  if (isAdminPage && !token) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  if (isLoginPage && token) {
    return NextResponse.redirect(new URL('/dashboard', request.url))
  }

  // API Route protection
  if (isApiRoute && !token) {
    return NextResponse.json(
      { error: 'Authentication required' },
      { status: 401 }
    )
  }

  return NextResponse.next()
}

export const config = {
  matcher: [
    // Match all paths except static files and api
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
}
```

### ğŸ” Advanced Authentication Patterns

#### JWT Token Validation
```tsx
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'
import { jwtVerify } from 'jose'

const secret = new TextEncoder().encode(process.env.JWT_SECRET)

async function verifyToken(token: string) {
  try {
    const { payload } = await jwtVerify(token, secret)
    return payload
  } catch (error) {
    return null
  }
}

export async function middleware(request: NextRequest) {
  const token = request.cookies.get('auth-token')?.value
  const pathname = request.nextUrl.pathname

  // Public paths that don't require authentication
  const publicPaths = ['/login', '/register', '/api/auth/login']
  if (publicPaths.includes(pathname)) {
    return NextResponse.next()
  }

  if (!token) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  // Verify token
  const user = await verifyToken(token)
  if (!user) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  // Role-based access control
  if (pathname.startsWith('/admin') && user.role !== 'admin') {
    return NextResponse.redirect(new URL('/unauthorized', request.url))
  }

  // Add user info to headers for use in components
  const response = NextResponse.next()
  response.headers.set('x-user-id', user.sub as string)
  response.headers.set('x-user-role', user.role as string)

  return response
}
```

### ğŸ“‹ Báº£ng so sÃ¡nh Middleware Patterns

| Pattern | Use Case | Pros | Cons |
|---------|----------|------|------|
| **Cookie-based** | Traditional web apps | Simple, secure | CSRF risk |
| **JWT Headers** | API-first apps | Stateless, scalable | Token size |
| **Session-based** | Server-side apps | Secure, revocable | Server memory |
| **OAuth/OIDC** | Third-party auth | Standard, feature-rich | Complex setup |

---

## 5. Redirects vÃ  Rewrites

### ğŸ”„ Permanent vs Temporary Redirects

#### next.config.js Configuration
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  async redirects() {
    return [
      // Permanent redirect (301)
      {
        source: '/old-blog/:path*',
        destination: '/blog/:path*',
        permanent: true,
      },
      // Temporary redirect (307)
      {
        source: '/maintenance',
        destination: '/coming-soon',
        permanent: false,
      },
      // Conditional redirect
      {
        source: '/admin/:path*',
        has: [
          {
            type: 'cookie',
            key: 'role',
            value: 'admin',
          },
        ],
        destination: '/admin/:path*',
        permanent: false,
      },
    ]
  },

  async rewrites() {
    return [
      // Simple rewrite
      {
        source: '/api/v1/:path*',
        destination: '/api/:path*',
      },
      // External API proxy
      {
        source: '/external-api/:path*',
        destination: 'https://api.external.com/:path*',
      },
    ]
  },
}

module.exports = nextConfig
```

### ğŸ¯ Dynamic Redirects trong Middleware

```tsx
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl
  
  // A/B testing redirect
  if (pathname === '/pricing') {
    const variant = Math.random() > 0.5 ? 'a' : 'b'
    return NextResponse.rewrite(
      new URL(`/pricing-${variant}`, request.url)
    )
  }

  // Geo-based redirect
  const country = request.geo?.country
  if (pathname === '/' && country === 'VN') {
    return NextResponse.redirect(new URL('/vi', request.url))
  }

  // Feature flag redirect
  const hasFeatureFlag = request.cookies.get('beta-features')
  if (pathname.startsWith('/beta') && !hasFeatureFlag) {
    return NextResponse.redirect(new URL('/coming-soon', request.url))
  }

  return NextResponse.next()
}
```

---

## ğŸ› ï¸ Thá»±c hÃ nh: XÃ¢y dá»±ng Dashboard vá»›i Advanced Routing

### ğŸ“‹ YÃªu cáº§u dá»± Ã¡n

<div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
  <h4 className="text-blue-800 font-semibold mb-3">ğŸ¯ Má»¥c tiÃªu thá»±c hÃ nh</h4>
  <p className="text-blue-700 mb-3">XÃ¢y dá»±ng má»™t dashboard admin vá»›i cÃ¡c tÃ­nh nÄƒng:</p>
  <ul className="text-blue-700 space-y-1">
    <li>âœ… Parallel routes cho sidebar vÃ  main content</li>
    <li>âœ… Modal cho user details (intercepting routes)</li>
    <li>âœ… Route groups cho admin vÃ  user areas</li>
    <li>âœ… Middleware protection cho admin routes</li>
    <li>âœ… Dynamic redirects based on user roles</li>
  </ul>
</div>

### ğŸ—ï¸ Implementation Steps

#### Step 1: Project Structure
```
app/
â”œâ”€â”€ middleware.ts
â”œâ”€â”€ layout.tsx
â”œâ”€â”€ (admin)/
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ @sidebar/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ @content/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â””â”€â”€ users/
â”‚       â”œâ”€â”€ @modal/
â”‚       â”‚   â””â”€â”€ (.)user/
â”‚       â”‚       â””â”€â”€ [id]/
â”‚       â”‚           â””â”€â”€ page.tsx
â”‚       â”œâ”€â”€ page.tsx
â”‚       â””â”€â”€ user/
â”‚           â””â”€â”€ [id]/
â”‚               â””â”€â”€ page.tsx
â”œâ”€â”€ (auth)/
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â””â”€â”€ register/
â”‚       â””â”€â”€ page.tsx
â””â”€â”€ components/
    â”œâ”€â”€ auth/
    â”œâ”€â”€ admin/
    â””â”€â”€ ui/
```

#### Step 2: Complete Implementation

Xem file hoÃ n chá»‰nh trong artifacts Ä‘á»ƒ cÃ³ code implementation Ä‘áº§y Ä‘á»§.

---

## ğŸ“š TÃ³m táº¯t vÃ  Checklist

### âœ… Kiáº¿n thá»©c Ä‘Ã£ há»c

| Concept | Status | Notes |
|---------|--------|-------|
| Parallel Routes (`@folder`) | âœ… | Hiá»ƒn thá»‹ multiple components |
| Intercepting Routes (`(.)`) | âœ… | Modal vÃ  overlay patterns |
| Route Groups (`(folder)`) | âœ… | Tá»• chá»©c code khÃ´ng áº£nh hÆ°á»Ÿng URL |
| Middleware | âœ… | Authentication vÃ  protection |
| Redirects & Rewrites | âœ… | URL manipulation |

### ğŸ¯ BÃ i táº­p vá» nhÃ 

1. **Má»Ÿ rá»™ng Dashboard**: ThÃªm thÃªm parallel routes cho notifications vÃ  statistics
2. **Modal Gallery**: Táº¡o photo gallery vá»›i intercepting routes
3. **Multi-tenant**: Implement route groups cho multiple tenants
4. **Advanced Middleware**: ThÃªm rate limiting vÃ  logging
5. **SEO Redirects**: Setup redirects cho old URLs

### ğŸ“– TÃ i liá»‡u tham kháº£o

- [Next.js Routing Documentation](https://nextjs.org/docs/app/building-your-application/routing)
- [Middleware Documentation](https://nextjs.org/docs/app/building-your-application/routing/middleware)
- [Parallel Routes Guide](https://nextjs.org/docs/app/building-your-application/routing/parallel-routes)

---

<div className="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-lg border-l-4 border-green-500">
  <h3 className="text-xl font-bold text-green-800 mb-2">ğŸ‰ ChÃºc má»«ng!</h3>
  <p className="text-green-700">Báº¡n Ä‘Ã£ hoÃ n thÃ nh BÃ i 7 vÃ  náº¯m vá»¯ng cÃ¡c advanced routing patterns trong Next.js. Nhá»¯ng kiáº¿n thá»©c nÃ y sáº½ giÃºp báº¡n xÃ¢y dá»±ng nhá»¯ng á»©ng dá»¥ng web phá»©c táº¡p vÃ  chuyÃªn nghiá»‡p.</p>
</div>