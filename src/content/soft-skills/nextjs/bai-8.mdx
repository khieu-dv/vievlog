# B√†i 8: Rendering Strategies trong Next.js

<div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
  <h2 className="text-xl font-semibold text-blue-800 mb-2">üéØ M·ª•c ti√™u b√†i h·ªçc</h2>
  <p className="text-blue-700">Sau khi ho√†n th√†nh b√†i h·ªçc n√†y, b·∫°n s·∫Ω:</p>
  <ul className="mt-2 text-blue-700">
    <li>‚Ä¢ Hi·ªÉu s·ª± kh√°c bi·ªát gi·ªØa Static v√† Dynamic Rendering</li>
    <li>‚Ä¢ Ph√¢n bi·ªát ƒë∆∞·ª£c Server Components v√† Client Components</li>
    <li>‚Ä¢ S·ª≠ d·ª•ng "use client" directive m·ªôt c√°ch hi·ªáu qu·∫£</li>
    <li>‚Ä¢ √Åp d·ª•ng Incremental Static Regeneration (ISR)</li>
    <li>‚Ä¢ Tri·ªÉn khai Streaming v√† Suspense boundaries</li>
  </ul>
</div>

## 1. T·ªïng quan v·ªÅ Rendering Strategies

Next.js cung c·∫•p nhi·ªÅu chi·∫øn l∆∞·ª£c rendering kh√°c nhau ƒë·ªÉ t·ªëi ∆∞u h√≥a hi·ªáu nƒÉng v√† tr·∫£i nghi·ªám ng∆∞·ªùi d√πng. Vi·ªác hi·ªÉu r√µ c√°c chi·∫øn l∆∞·ª£c n√†y l√† ch√¨a kh√≥a ƒë·ªÉ x√¢y d·ª±ng ·ª©ng d·ª•ng web hi·ªáu qu·∫£.

```mermaid
graph TD
    A[Next.js Rendering] --> B[Static Rendering]
    A --> C[Dynamic Rendering]
    A --> D[Streaming]
    
    B --> B1[Build Time]
    B --> B2[ISR - On Demand]
    
    C --> C1[Request Time]
    C --> C2[Server Components]
    
    D --> D1[Progressive Loading]
    D --> D2[Suspense Boundaries]
```

## 2. Static Rendering vs Dynamic Rendering

### Static Rendering (Tƒ©nh)

Static Rendering x·∫£y ra t·∫°i **build time** ho·∫∑c trong qu√° tr√¨nh **revalidation**. N√≥ t·∫°o ra HTML tƒ©nh c√≥ th·ªÉ ƒë∆∞·ª£c cache v√† ph·ª•c v·ª• t·ª´ CDN.

| ƒê·∫∑c ƒëi·ªÉm | Static Rendering | Dynamic Rendering |
|----------|------------------|-------------------|
| **Th·ªùi ƒëi·ªÉm render** | Build time / Revalidation | Request time |
| **Hi·ªáu nƒÉng** | R·∫•t cao (CDN cache) | Ph·ª• thu·ªôc server |
| **T√≠nh real-time** | Kh√¥ng | C√≥ |
| **SEO** | Xu·∫•t s·∫Øc | T·ªët |
| **Ph√π h·ª£p cho** | Blog, Landing Page | Dashboard, User Profile |

```typescript
// app/blog/page.tsx - Static Rendering
export default function BlogPage() {
  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">Blog Posts</h1>
      <p>Trang n√†y ƒë∆∞·ª£c render t·∫°i build time</p>
    </div>
  );
}
```

### Dynamic Rendering (ƒê·ªông)

Dynamic Rendering x·∫£y ra t·∫°i **request time** cho m·ªói user request. N√≥ ph√π h·ª£p cho content c√° nh√¢n h√≥a ho·∫∑c d·ªØ li·ªáu thay ƒë·ªïi th∆∞·ªùng xuy√™n.

```typescript
// app/dashboard/page.tsx - Dynamic Rendering
import { headers } from 'next/headers';

export default async function Dashboard() {
  const headersList = headers();
  const userAgent = headersList.get('user-agent');
  
  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">Dashboard</h1>
      <p className="text-gray-600">User Agent: {userAgent}</p>
    </div>
  );
}
```

<div className="bg-yellow-50 border-l-4 border-yellow-500 p-4 my-6">
  <h3 className="font-semibold text-yellow-800">‚ö° L∆∞u √Ω quan tr·ªçng</h3>
  <p className="text-yellow-700 mt-2">
    Next.js t·ª± ƒë·ªông chuy·ªÉn t·ª´ Static sang Dynamic rendering khi ph√°t hi·ªán:
  </p>
  <ul className="mt-2 text-yellow-700">
    <li>‚Ä¢ Dynamic functions (headers(), cookies(), searchParams)</li>
    <li>‚Ä¢ Uncached data requests</li>
    <li>‚Ä¢ Dynamic segments trong URL</li>
  </ul>
</div>

## 3. Server Components vs Client Components

### Server Components (M·∫∑c ƒë·ªãnh)

Server Components ch·∫°y tr√™n server v√† render th√†nh HTML tr∆∞·ªõc khi g·ª≠i ƒë·∫øn client.

**∆Øu ƒëi·ªÉm:**
- Bundle size nh·ªè h∆°n
- Truy c·∫≠p tr·ª±c ti·∫øp database
- B·∫£o m·∫≠t cao h∆°n (API keys, tokens)
- SEO t·ªët

```typescript
// app/products/page.tsx - Server Component
async function getProducts() {
  const res = await fetch('https://api.example.com/products', {
    cache: 'force-cache' // Static
  });
  return res.json();
}

export default async function ProductsPage() {
  const products = await getProducts();
  
  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 p-6">
      {products.map((product: any) => (
        <div key={product.id} className="border rounded-lg p-4">
          <h3 className="font-semibold">{product.name}</h3>
          <p className="text-gray-600">${product.price}</p>
        </div>
      ))}
    </div>
  );
}
```

### Client Components

Client Components ch·∫°y tr√™n browser v√† cho ph√©p interactivity.

```typescript
// app/components/Counter.tsx - Client Component
'use client';

import { useState } from 'react';

export default function Counter() {
  const [count, setCount] = useState(0);
  
  return (
    <div className="p-4 border rounded-lg">
      <p className="text-lg mb-4">Count: {count}</p>
      <div className="space-x-2">
        <button 
          onClick={() => setCount(count + 1)}
          className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
        >
          Increment
        </button>
        <button 
          onClick={() => setCount(count - 1)}
          className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
        >
          Decrement
        </button>
      </div>
    </div>
  );
}
```

### Khi n√†o s·ª≠ d·ª•ng "use client"?

| T√¨nh hu·ªëng | Server Component | Client Component |
|------------|------------------|------------------|
| Fetch data t·ª´ API | ‚úÖ | ‚ùå |
| Event handlers (onClick, onChange) | ‚ùå | ‚úÖ |
| React Hooks (useState, useEffect) | ‚ùå | ‚úÖ |
| Browser APIs (localStorage, window) | ‚ùå | ‚úÖ |
| Database queries tr·ª±c ti·∫øp | ‚úÖ | ‚ùå |

```mermaid
flowchart TD
    A[Component c·∫ßn render?] --> B{C·∫ßn interactivity?}
    B -->|C√≥| C{S·ª≠ d·ª•ng hooks/events?}
    B -->|Kh√¥ng| D[Server Component]
    C -->|C√≥| E['use client']
    C -->|Kh√¥ng| F{Truy c·∫≠p browser APIs?}
    F -->|C√≥| E
    F -->|Kh√¥ng| D
```

## 4. Incremental Static Regeneration (ISR)

ISR cho ph√©p b·∫°n c·∫≠p nh·∫≠t static content sau khi ƒë√£ build m√† kh√¥ng c·∫ßn rebuild to√†n b·ªô site.

### C√°ch ho·∫°t ƒë·ªông c·ªßa ISR

```mermaid
sequenceDiagram
    participant U as User
    participant C as CDN Cache
    participant S as Server
    participant D as Database
    
    U->>C: Request page
    C->>U: Return cached page (stale)
    C->>S: Trigger revalidation
    S->>D: Fetch fresh data
    D->>S: Return new data
    S->>S: Generate new page
    S->>C: Update cache
    
    Note over C: Next request gets fresh page
```

### Time-based Revalidation

```typescript
// app/posts/page.tsx - ISR v·ªõi time-based revalidation
async function getPosts() {
  const res = await fetch('https://api.example.com/posts', {
    next: { 
      revalidate: 3600 // Revalidate m·ªói 1 gi·ªù
    }
  });
  
  if (!res.ok) {
    throw new Error('Failed to fetch posts');
  }
  
  return res.json();
}

export default async function PostsPage() {
  const posts = await getPosts();
  
  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">Latest Posts</h1>
      <div className="space-y-4">
        {posts.map((post: any) => (
          <article key={post.id} className="border-b pb-4">
            <h2 className="text-xl font-semibold mb-2">{post.title}</h2>
            <p className="text-gray-600">{post.excerpt}</p>
            <time className="text-sm text-gray-500">
              {new Date(post.createdAt).toLocaleDateString()}
            </time>
          </article>
        ))}
      </div>
    </div>
  );
}
```

### On-demand Revalidation

```typescript
// app/api/revalidate/route.ts - API route ƒë·ªÉ trigger revalidation
import { revalidatePath } from 'next/cache';
import { NextRequest } from 'next/server';

export async function POST(request: NextRequest) {
  const secret = request.nextUrl.searchParams.get('secret');
  
  if (secret !== process.env.REVALIDATE_SECRET) {
    return Response.json({ message: 'Invalid secret' }, { status: 401 });
  }
  
  try {
    // Revalidate specific path
    revalidatePath('/posts');
    
    return Response.json({ 
      message: 'Revalidation successful',
      now: Date.now()
    });
  } catch (error) {
    return Response.json({ 
      message: 'Error revalidating',
      error: error instanceof Error ? error.message : 'Unknown error'
    }, { status: 500 });
  }
}
```

## 5. Streaming v√† Suspense

Streaming cho ph√©p g·ª≠i HTML theo t·ª´ng ph·∫ßn, c·∫£i thi·ªán perceived performance v√† Time to First Byte (TTFB).

### Loading.tsx - Route-level Suspense

```typescript
// app/dashboard/loading.tsx
export default function DashboardLoading() {
  return (
    <div className="max-w-4xl mx-auto p-6">
      <div className="animate-pulse">
        <div className="h-8 bg-gray-300 rounded w-1/4 mb-6"></div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {[1, 2, 3].map((i) => (
            <div key={i} className="h-32 bg-gray-300 rounded"></div>
          ))}
        </div>
      </div>
    </div>
  );
}
```

### Component-level Suspense

```typescript
// app/dashboard/page.tsx - S·ª≠ d·ª•ng Suspense boundaries
import { Suspense } from 'react';

async function UserStats() {
  await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate slow API
  return (
    <div className="bg-blue-100 p-4 rounded-lg">
      <h3 className="font-semibold">User Statistics</h3>
      <p>1,234 total visits</p>
    </div>
  );
}

async function RecentActivity() {
  await new Promise(resolve => setTimeout(resolve, 1000)); // Faster API
  return (
    <div className="bg-green-100 p-4 rounded-lg">
      <h3 className="font-semibold">Recent Activity</h3>
      <p>Last login: 2 hours ago</p>
    </div>
  );
}

function StatsSkeleton() {
  return (
    <div className="bg-gray-100 p-4 rounded-lg animate-pulse">
      <div className="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
      <div className="h-4 bg-gray-300 rounded w-1/2"></div>
    </div>
  );
}

function ActivitySkeleton() {
  return (
    <div className="bg-gray-100 p-4 rounded-lg animate-pulse">
      <div className="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
      <div className="h-4 bg-gray-300 rounded w-2/3"></div>
    </div>
  );
}

export default function Dashboard() {
  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">Dashboard</h1>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <Suspense fallback={<StatsSkeleton />}>
          <UserStats />
        </Suspense>
        
        <Suspense fallback={<ActivitySkeleton />}>
          <RecentActivity />
        </Suspense>
      </div>
    </div>
  );
}
```

## 6. Hydration v√† Partial Hydration

### Hi·ªÉu v·ªÅ Hydration Process

```mermaid
graph LR
    A[Server HTML] --> B[Client Download]
    B --> C[React Hydration]
    C --> D[Interactive App]
    
    subgraph "Hydration Process"
        E[Static HTML]
        F[Attach Event Listeners]
        G[Initialize State]
        H[Component Tree Ready]
        
        E --> F --> G --> H
    end
```

### T·ªëi ∆∞u h√≥a Hydration

```typescript
// app/components/OptimizedComponent.tsx
'use client';

import { useState, useEffect } from 'react';

export default function OptimizedComponent() {
  const [mounted, setMounted] = useState(false);
  const [data, setData] = useState(null);
  
  useEffect(() => {
    setMounted(true);
    // Ch·ªâ ch·∫°y client-side logic sau khi mounted
    if (typeof window !== 'undefined') {
      // Browser-specific code
    }
  }, []);
  
  if (!mounted) {
    // Return server-side compatible JSX
    return <div className="p-4 border rounded">Loading...</div>;
  }
  
  return (
    <div className="p-4 border rounded">
      <h3 className="font-semibold mb-2">Client-side Component</h3>
      <p>This component is fully hydrated!</p>
    </div>
  );
}
```

## 7. Best Practices v√† Performance Tips

### B·∫£ng so s√°nh Rendering Strategies

| Use Case | Recommended Strategy | L√Ω do |
|----------|---------------------|-------|
| **Landing Page** | Static Rendering | SEO t·ªëi ∆∞u, t·ªëc ƒë·ªô cao |
| **Blog Posts** | ISR | Content √≠t thay ƒë·ªïi, SEO t·ªët |
| **User Dashboard** | Dynamic Rendering | D·ªØ li·ªáu c√° nh√¢n h√≥a |
| **E-commerce Product** | ISR + Client hydration | C√¢n b·∫±ng SEO v√† UX |
| **Real-time Chat** | Client Components | C·∫ßn interactivity cao |

### Performance Optimization Checklist

<div className="bg-green-50 border-l-4 border-green-500 p-4 my-6">
  <h3 className="font-semibold text-green-800 mb-2">‚úÖ Optimization Checklist</h3>
  <div className="text-green-700">
    <p><strong>Static Content:</strong></p>
    <ul className="ml-4 mb-3">
      <li>‚Ä¢ S·ª≠ d·ª•ng Static Rendering cho pages kh√¥ng thay ƒë·ªïi</li>
      <li>‚Ä¢ Implement ISR cho content c·∫≠p nh·∫≠t ƒë·ªãnh k·ª≥</li>
    </ul>
    
    <p><strong>Dynamic Content:</strong></p>
    <ul className="ml-4 mb-3">
      <li>‚Ä¢ Minimize Client Components</li>
      <li>‚Ä¢ Use Suspense cho data fetching</li>
    </ul>
    
    <p><strong>User Experience:</strong></p>
    <ul className="ml-4">
      <li>‚Ä¢ Implement loading states</li>
      <li>‚Ä¢ Progressive enhancement</li>
    </ul>
  </div>
</div>

## 8. Th·ª±c h√†nh: T·ªëi ∆∞u h√≥a Rendering

### B√†i t·∫≠p 1: Blog v·ªõi ISR

T·∫°o m·ªôt blog application s·ª≠ d·ª•ng ISR:

```typescript
// app/blog/[slug]/page.tsx
interface Post {
  id: string;
  title: string;
  content: string;
  createdAt: string;
}

async function getPost(slug: string): Promise<Post> {
  const res = await fetch(`https://api.example.com/posts/${slug}`, {
    next: { 
      revalidate: 3600, // 1 hour
      tags: ['posts', `post-${slug}`]
    }
  });
  
  if (!res.ok) {
    throw new Error('Post not found');
  }
  
  return res.json();
}

export async function generateStaticParams() {
  const posts = await fetch('https://api.example.com/posts').then(res => res.json());
  
  return posts.map((post: Post) => ({
    slug: post.id,
  }));
}

export default async function BlogPost({ 
  params 
}: { 
  params: { slug: string } 
}) {
  const post = await getPost(params.slug);
  
  return (
    <article className="max-w-3xl mx-auto p-6">
      <h1 className="text-4xl font-bold mb-4">{post.title}</h1>
      <time className="text-gray-500 block mb-6">
        {new Date(post.createdAt).toLocaleDateString()}
      </time>
      <div 
        className="prose prose-lg max-w-none"
        dangerouslySetInnerHTML={{ __html: post.content }}
      />
    </article>
  );
}
```

### B√†i t·∫≠p 2: Dashboard v·ªõi Mixed Rendering

K·∫øt h·ª£p Server v√† Client Components:

```typescript
// app/dashboard/page.tsx
import { Suspense } from 'react';
import ServerStats from './components/ServerStats';
import ClientChart from './components/ClientChart';

export default function Dashboard() {
  return (
    <div className="max-w-6xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-8">Analytics Dashboard</h1>
      
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* Server-side rendered stats */}
        <Suspense fallback={<div className="h-64 bg-gray-100 animate-pulse rounded-lg" />}>
          <ServerStats />
        </Suspense>
        
        {/* Client-side interactive chart */}
        <ClientChart />
      </div>
    </div>
  );
}
```

## T·ªïng k·∫øt

Trong b√†i h·ªçc n√†y, ch√∫ng ta ƒë√£ t√¨m hi·ªÉu v·ªÅ c√°c chi·∫øn l∆∞·ª£c rendering trong Next.js:

- **Static vs Dynamic Rendering**: Hi·ªÉu khi n√†o n√™n s·ª≠ d·ª•ng t·ª´ng lo·∫°i
- **Server vs Client Components**: Ph√¢n bi·ªát r√µ r√†ng v√† s·ª≠ d·ª•ng h·ª£p l√Ω
- **ISR**: C·∫≠p nh·∫≠t content tƒ©nh m√† kh√¥ng c·∫ßn rebuild
- **Streaming**: C·∫£i thi·ªán perceived performance v·ªõi Suspense
- **Hydration**: T·ªëi ∆∞u h√≥a qu√° tr√¨nh chuy·ªÉn ƒë·ªïi t·ª´ static sang interactive

Vi·ªác l·ª±a ch·ªçn ƒë√∫ng rendering strategy s·∫Ω gi√∫p ·ª©ng d·ª•ng c·ªßa b·∫°n c√≥ hi·ªáu nƒÉng t·ªëi ∆∞u v√† tr·∫£i nghi·ªám ng∆∞·ªùi d√πng t·ªët nh·∫•t.

---

<div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-8">
  <h3 className="font-semibold text-blue-800 mb-2">üéØ B√†i t·∫≠p v·ªÅ nh√†</h3>
  <p className="text-blue-700">
    X√¢y d·ª±ng m·ªôt ·ª©ng d·ª•ng news aggregator s·ª≠ d·ª•ng:
  </p>
  <ul className="mt-2 text-blue-700 ml-4">
    <li>‚Ä¢ Static rendering cho trang ch·ªß</li>
    <li>‚Ä¢ ISR cho t·ª´ng b√†i b√°o</li>
    <li>‚Ä¢ Client components cho t√≠nh nƒÉng search v√† filter</li>
    <li>‚Ä¢ Streaming cho comments section</li>
  </ul>
</div>