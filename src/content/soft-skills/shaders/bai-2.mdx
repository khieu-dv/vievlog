# BÃ i 2: Cáº¥u trÃºc cÆ¡ báº£n cá»§a WGSL shader

<div className="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg border-l-4 border-blue-500 mb-8">
  <h2 className="text-2xl font-bold text-gray-800 mb-2">ğŸ¯ Má»¥c tiÃªu há»c táº­p</h2>
  <ul className="list-disc list-inside space-y-2 text-gray-700">
    <li>Náº¯m vá»¯ng syntax cÆ¡ báº£n cá»§a WGSL (variables, functions, types)</li>
    <li>Hiá»ƒu rÃµ vá» vertex input vÃ  fragment output trong pipeline rendering</li>
    <li>Táº¡o Ä‘Æ°á»£c vertex shader Ä‘Æ¡n giáº£n Ä‘á»ƒ váº½ hÃ¬nh tam giÃ¡c</li>
    <li>LÃ m viá»‡c thÃ nh tháº¡o vá»›i cÃ¡c kiá»ƒu dá»¯ liá»‡u: vec2, vec3, vec4, mat4</li>
    <li>Táº¡o fragment shader Ä‘á»ƒ tÃ´ mÃ u cÆ¡ báº£n</li>
    <li>Debug vÃ  kháº¯c phá»¥c lá»—i shader hiá»‡u quáº£</li>
  </ul>
</div>

## ğŸ“š LÃ½ thuyáº¿t cÆ¡ báº£n

### 1. WebGPU Shading Language (WGSL) lÃ  gÃ¬?

**WGSL** lÃ  ngÃ´n ngá»¯ shader chÃ­nh thá»©c cá»§a WebGPU, Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ:
- Cháº¡y native trÃªn má»i platform (Windows, macOS, Linux, Web)
- Cung cáº¥p syntax hiá»‡n Ä‘áº¡i vÃ  type-safe
- Tá»‘i Æ°u hÃ³a hiá»‡u suáº¥t cho GPU hiá»‡n Ä‘áº¡i

### 2. So sÃ¡nh WGSL vá»›i cÃ¡c ngÃ´n ngá»¯ shader khÃ¡c

| Äáº·c Ä‘iá»ƒm | WGSL | GLSL | HLSL |
|----------|------|------|------|
| **Platform** | Cross-platform | OpenGL/Vulkan | DirectX |
| **Type System** | Strict typing | Loose typing | Medium typing |
| **Syntax** | Rust-like | C-like | C++-like |
| **Memory Model** | Explicit | Implicit | Mixed |
| **Precision** | Explicit | Varying | Explicit |

## ğŸ—ï¸ Cáº¥u trÃºc Rendering Pipeline

```mermaid
graph TD
    A[Vertex Data] --> B[Vertex Shader]
    B --> C[Rasterization]
    C --> D[Fragment Shader]
    D --> E[Color Output]
    
    F[Uniforms] --> B
    F --> D
    G[Textures] --> D
    
    style B fill:#e1f5fe
    style D fill:#f3e5f5
    style C fill:#e8f5e8
```

<div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 my-6">
  <div className="flex">
    <div className="flex-shrink-0">
      <svg className="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
        <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
      </svg>
    </div>
    <div className="ml-3">
      <p className="text-sm text-yellow-700">
        <strong>LÆ°u Ã½ quan trá»ng:</strong> Vertex Shader xá»­ lÃ½ tá»«ng vertex riÃªng biá»‡t, trong khi Fragment Shader xá»­ lÃ½ tá»«ng pixel Ä‘Æ°á»£c rasterize.
      </p>
    </div>
  </div>
</div>

## ğŸ”§ Cáº¥u trÃºc cÆ¡ báº£n cá»§a WGSL Shader

### 1. Kiá»ƒu dá»¯ liá»‡u cÆ¡ báº£n

| Kiá»ƒu dá»¯ liá»‡u | MÃ´ táº£ | VÃ­ dá»¥ sá»­ dá»¥ng |
|--------------|--------|---------------|
| `f32` | Sá»‘ thá»±c 32-bit | `var position: f32 = 1.5;` |
| `i32` | Sá»‘ nguyÃªn 32-bit cÃ³ dáº¥u | `var count: i32 = 10;` |
| `u32` | Sá»‘ nguyÃªn 32-bit khÃ´ng dáº¥u | `var index: u32 = 0u;` |
| `bool` | Boolean | `var is_visible: bool = true;` |
| `vec2<f32>` | Vector 2D | `var uv: vec2<f32> = vec2(0.5, 0.5);` |
| `vec3<f32>` | Vector 3D | `var color: vec3<f32> = vec3(1.0, 0.0, 0.0);` |
| `vec4<f32>` | Vector 4D | `var position: vec4<f32> = vec4(0.0, 0.0, 0.0, 1.0);` |
| `mat4x4<f32>` | Ma tráº­n 4x4 | `var transform: mat4x4<f32>;` |

### 2. Cáº¥u trÃºc Vertex Input vÃ  Output

```wgsl
// Vertex Input Structure
struct VertexInput {
    @location(0) position: vec3<f32>,    // Vá»‹ trÃ­ vertex
    @location(1) color: vec3<f32>,       // MÃ u sáº¯c vertex
    @location(2) uv: vec2<f32>,          // Tá»a Ä‘á»™ texture
}

// Vertex Output Structure  
struct VertexOutput {
    @builtin(position) position: vec4<f32>,  // Vá»‹ trÃ­ trong clip space
    @location(0) color: vec3<f32>,           // MÃ u sáº¯c interpolated
    @location(1) uv: vec2<f32>,              // UV coordinates
}
```

## ğŸ’¡ Táº¡o Vertex Shader Ä‘áº§u tiÃªn

<div className="bg-blue-50 p-6 rounded-lg mb-6">
  <h3 className="text-lg font-semibold text-blue-800 mb-3">ğŸš€ Thá»±c hÃ nh: Vertex Shader cÆ¡ báº£n</h3>

### BÆ°á»›c 1: Táº¡o Vertex Shader váº½ tam giÃ¡c

```wgsl
// vertex_shader.wgsl
struct VertexInput {
    @location(0) position: vec3<f32>,
    @location(1) color: vec3<f32>,
}

struct VertexOutput {
    @builtin(position) clip_position: vec4<f32>,
    @location(0) color: vec3<f32>,
}

@vertex
fn vs_main(vertex: VertexInput) -> VertexOutput {
    var output: VertexOutput;
    
    // Chuyá»ƒn Ä‘á»•i position tá»« 3D sang clip space 4D
    output.clip_position = vec4<f32>(vertex.position, 1.0);
    
    // Truyá»n mÃ u sáº¯c xuá»‘ng fragment shader
    output.color = vertex.color;
    
    return output;
}
```

### BÆ°á»›c 2: Táº¡o Fragment Shader

```wgsl
// fragment_shader.wgsl
struct FragmentInput {
    @location(0) color: vec3<f32>,
}

@fragment  
fn fs_main(input: FragmentInput) -> @location(0) vec4<f32> {
    // Tráº£ vá» mÃ u sáº¯c vá»›i alpha = 1.0 (khÃ´ng trong suá»‘t)
    return vec4<f32>(input.color, 1.0);
}
```

</div>

## ğŸ¨ TÃ­ch há»£p vá»›i Bevy Engine

### 1. Táº¡o Custom Material trong Bevy

```rust
// src/triangle_material.rs
use bevy::{
    prelude::*,
    reflect::TypeUuid,
    render::render_resource::*,
};

#[derive(AsBindGroup, TypeUuid, Debug, Clone)]
#[uuid = "f690fdae-d598-45ab-8225-97e2a3f056e0"]
pub struct TriangleMaterial {
    #[uniform(0)]
    pub base_color: Color,
}

impl Material for TriangleMaterial {
    fn vertex_shader() -> ShaderRef {
        "shaders/triangle_vertex.wgsl".into()
    }

    fn fragment_shader() -> ShaderRef {
        "shaders/triangle_fragment.wgsl".into()
    }
}
```

### 2. Setup Bevy App

```rust
// src/main.rs
use bevy::{prelude::*, render::mesh::Indices};

fn main() {
    App::new()
        .add_plugins(DefaultPlugins)
        .add_plugin(MaterialPlugin::<TriangleMaterial>::default())
        .add_startup_system(setup)
        .run();
}

fn setup(
    mut commands: Commands,
    mut meshes: ResMut<Assets<Mesh>>,
    mut materials: ResMut<Assets<TriangleMaterial>>,
) {
    // Táº¡o mesh tam giÃ¡c
    let triangle_mesh = create_triangle_mesh();
    
    // Spawn entity vá»›i triangle mesh
    commands.spawn(MaterialMeshBundle {
        mesh: meshes.add(triangle_mesh),
        material: materials.add(TriangleMaterial {
            base_color: Color::RED,
        }),
        ..default()
    });
    
    // Camera
    commands.spawn(Camera3dBundle {
        transform: Transform::from_xyz(0.0, 0.0, 5.0),
        ..default()
    });
}

fn create_triangle_mesh() -> Mesh {
    let vertices = vec![
        // Position        // Color
        [0.0, 0.5, 0.0],   [1.0, 0.0, 0.0], // Äá»‰nh trÃªn - Ä‘á»
        [-0.5, -0.5, 0.0], [0.0, 1.0, 0.0], // Äá»‰nh trÃ¡i - xanh lÃ¡
        [0.5, -0.5, 0.0],  [0.0, 0.0, 1.0], // Äá»‰nh pháº£i - xanh dÆ°Æ¡ng
    ];
    
    let indices = vec![0, 1, 2]; // Thá»© tá»± vertices
    
    let mut mesh = Mesh::new(PrimitiveTopology::TriangleList);
    
    // TÃ¡ch positions vÃ  colors
    let positions: Vec<[f32; 3]> = vertices.iter()
        .map(|v| [v[0], v[1], v[2]]).collect();
    let colors: Vec<[f32; 3]> = vertices.iter()
        .map(|v| [v[3], v[4], v[5]]).collect();
    
    mesh.insert_attribute(Mesh::ATTRIBUTE_POSITION, positions);
    mesh.insert_attribute(Mesh::ATTRIBUTE_COLOR, colors);
    mesh.set_indices(Some(Indices::U32(indices)));
    
    mesh
}
```

## ğŸ” Debug vÃ  Troubleshooting

### CÃ¡c lá»—i thÆ°á»ng gáº·p vÃ  cÃ¡ch kháº¯c phá»¥c

<div className="overflow-x-auto">
  <table className="w-full border-collapse border border-gray-300 bg-white">
    <thead className="bg-gray-50">
      <tr>
        <th className="border border-gray-300 px-4 py-2 text-left font-medium text-gray-700">Lá»—i</th>
        <th className="border border-gray-300 px-4 py-2 text-left font-medium text-gray-700">NguyÃªn nhÃ¢n</th>
        <th className="border border-gray-300 px-4 py-2 text-left font-medium text-gray-700">Giáº£i phÃ¡p</th>
      </tr>
    </thead>
    <tbody>
      <tr className="hover:bg-gray-50">
        <td className="border border-gray-300 px-4 py-2 font-mono text-sm">Shader compilation error</td>
        <td className="border border-gray-300 px-4 py-2">Syntax sai trong WGSL</td>
        <td className="border border-gray-300 px-4 py-2">Kiá»ƒm tra syntax, missing semicolons</td>
      </tr>
      <tr className="hover:bg-gray-50">
        <td className="border border-gray-300 px-4 py-2 font-mono text-sm">Binding mismatch</td>
        <td className="border border-gray-300 px-4 py-2">@location khÃ´ng khá»›p</td>
        <td className="border border-gray-300 px-4 py-2">Äáº£m báº£o vertex output = fragment input</td>
      </tr>
      <tr className="hover:bg-gray-50">
        <td className="border border-gray-300 px-4 py-2 font-mono text-sm">Black screen</td>
        <td className="border border-gray-300 px-4 py-2">Vertices ngoÃ i clip space</td>
        <td className="border border-gray-300 px-4 py-2">Kiá»ƒm tra position values [-1, 1] range</td>
      </tr>
      <tr className="hover:bg-gray-50">
        <td className="border border-gray-300 px-4 py-2 font-mono text-sm">Wrong colors</td>
        <td className="border border-gray-300 px-4 py-2">Color range khÃ´ng Ä‘Ãºng</td>
        <td className="border border-gray-300 px-4 py-2">Sá»­ dá»¥ng [0.0, 1.0] cho mÃ u sáº¯c</td>
      </tr>
    </tbody>
  </table>
</div>

### Tools Debug há»¯u Ã­ch

```mermaid
graph LR
    A[Debug Tools] --> B[RenderDoc]
    A --> C[Bevy Inspector]
    A --> D[Console Logs]
    A --> E[Shader Validator]
    
    B --> F[Frame Capture]
    B --> G[Shader Analysis]
    
    C --> H[Real-time Material Editor]
    C --> I[Component Inspector]
    
    style A fill:#f9f9f9
    style B fill:#e3f2fd
    style C fill:#e8f5e8
```

## ğŸ‹ï¸ BÃ i táº­p thá»±c hÃ nh

<div className="bg-green-50 border-l-4 border-green-400 p-6 my-6">
  <h3 className="text-lg font-semibold text-green-800 mb-3">ğŸ’ª Thá»­ thÃ¡ch</h3>
  
### BÃ i táº­p 1: Táº¡o hÃ¬nh vuÃ´ng cÃ³ mÃ u gradient

**YÃªu cáº§u:**
- Táº¡o mesh hÃ¬nh vuÃ´ng vá»›i 4 vertices
- Má»—i gÃ³c cÃ³ mÃ u sáº¯c khÃ¡c nhau
- Sá»­ dá»¥ng indices Ä‘á»ƒ táº¡o 2 tam giÃ¡c

### BÃ i táº­p 2: Animation Ä‘Æ¡n giáº£n

**YÃªu cáº§u:**
- ThÃªm uniform `time` vÃ o shader
- Táº¡o hiá»‡u á»©ng xoay tam giÃ¡c
- Thay Ä‘á»•i mÃ u sáº¯c theo thá»i gian

### BÃ i táº­p 3: Multiple shapes

**YÃªu cáº§u:**
- Táº¡o nhiá»u hÃ¬nh dáº¡ng khÃ¡c nhau
- Sá»­ dá»¥ng cÃ¹ng má»™t shader
- Ãp dá»¥ng transforms khÃ¡c nhau

</div>

## ğŸ“ TÃ³m táº¯t kiáº¿n thá»©c

### Checklist kiáº¿n thá»©c cáº§n náº¯m vá»¯ng:

- [ ] **Syntax WGSL cÆ¡ báº£n**: Variables, functions, structs
- [ ] **Kiá»ƒu dá»¯ liá»‡u**: vec2, vec3, vec4, mat4x4
- [ ] **Vertex Input/Output**: @location, @builtin attributes  
- [ ] **Vertex Shader**: Xá»­ lÃ½ position vÃ  attributes
- [ ] **Fragment Shader**: Táº¡o mÃ u sáº¯c cho pixels
- [ ] **Bevy Integration**: Material trait, mesh creation
- [ ] **Debug Skills**: Troubleshooting vÃ  error fixing

### Äiá»ƒm chuáº©n Ä‘Ã¡nh giÃ¡:

| Má»©c Ä‘á»™ | MÃ´ táº£ | TiÃªu chÃ­ |
|--------|-------|----------|
| **CÆ¡ báº£n** | Hiá»ƒu syntax WGSL | Táº¡o Ä‘Æ°á»£c shader Ä‘Æ¡n giáº£n khÃ´ng lá»—i |
| **Trung bÃ¬nh** | TÃ­ch há»£p Bevy thÃ nh cÃ´ng | Render Ä‘Æ°á»£c hÃ¬nh tam giÃ¡c vá»›i mÃ u |
| **KhÃ¡** | Custom materials | Táº¡o Ä‘Æ°á»£c nhiá»u shapes khÃ¡c nhau |
| **Giá»i** | Animation cÆ¡ báº£n | ThÃªm Ä‘Æ°á»£c movement vÃ  color animation |

---

<div className="bg-blue-100 border border-blue-300 rounded-lg p-6 mt-8">
  <h3 className="text-xl font-bold text-blue-800 mb-3">ğŸ“‹ Chuáº©n bá»‹ cho BÃ i 3</h3>
  <p className="text-blue-700 mb-4">
    Trong bÃ i há»c tiáº¿p theo, chÃºng ta sáº½ tÃ¬m hiá»ƒu vá» <strong>Uniforms vÃ  Bindings trong Bevy</strong> - cÃ¡ch truyá»n dá»¯ liá»‡u tá»« CPU sang GPU má»™t cÃ¡ch hiá»‡u quáº£.
  </p>
  
  <h4 className="font-semibold text-blue-800 mb-2">Kiáº¿n thá»©c cáº§n Ã´n táº­p:</h4>
  <ul className="list-disc list-inside text-blue-700 space-y-1">
    <li>CÃ¡ch táº¡o struct trong WGSL</li>
    <li>Hiá»ƒu vá» binding trong GPU programming</li>
    <li>Bevy Material trait vÃ  custom properties</li>
    <li>Rust ownership vÃ  borrowing (Ä‘á»ƒ hiá»ƒu uniform buffers)</li>
  </ul>
  
  <div className="mt-4 p-3 bg-blue-50 rounded">
    <p className="text-sm text-blue-600">
      <strong>ğŸ’¡ Tip:</strong> Thá»±c hÃ nh táº¡o thÃªm nhiá»u shapes vÃ  thá»­ nghiá»‡m vá»›i cÃ¡c mÃ u sáº¯c khÃ¡c nhau Ä‘á»ƒ lÃ m quen vá»›i vertex attributes!
    </p>
  </div>
</div>