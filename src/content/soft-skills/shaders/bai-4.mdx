# B√†i 4: Vertex Transformation c∆° b·∫£n

<div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-lg mb-8">
  <h2 className="text-2xl font-bold mb-2">üéØ M·ª•c ti√™u b√†i h·ªçc</h2>
  <p className="text-lg">Hi·ªÉu v√† th·ª±c h√†nh c√°c ph√©p bi·∫øn ƒë·ªïi vertex c∆° b·∫£n trong 3D graphics, t·ª´ model space ƒë·∫øn screen space</p>
</div>

## üìö N·ªôi dung ch√≠nh

### 1. Warm-up & Review (5 ph√∫t)

<div className="bg-gray-100 p-4 rounded-md mb-4">
  <h4 className="font-semibold text-gray-800 mb-2">√în t·∫≠p b√†i tr∆∞·ªõc:</h4>
  <ul className="list-disc pl-5 text-gray-700">
    <li>C√°ch t·∫°o v√† s·ª≠ d·ª•ng uniform buffers trong Bevy</li>
    <li>Truy·ªÅn d·ªØ li·ªáu t·ª´ CPU sang GPU</li>
    <li>C·∫•u tr√∫c Material trait t√πy ch·ªânh</li>
  </ul>
</div>

---

## üåê Coordinate Systems - C√°c h·ªá t·ªça ƒë·ªô trong 3D Graphics

Tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu v·ªõi vertex transformation, ch√∫ng ta c·∫ßn hi·ªÉu r√µ c√°c h·ªá t·ªça ƒë·ªô kh√°c nhau trong pipeline render 3D.

```mermaid
graph TD
    A[Model Space<br/>Local Coordinates] --> B[World Space<br/>Global Scene Coordinates]
    B --> C[View Space<br/>Camera Coordinates]  
    C --> D[Clip Space<br/>Projection Coordinates]
    D --> E[Screen Space<br/>Pixel Coordinates]
    
    A -.->|Model Matrix| B
    B -.->|View Matrix| C
    C -.->|Projection Matrix| D
    D -.->|Viewport Transform| E
```

### B·∫£ng so s√°nh c√°c h·ªá t·ªça ƒë·ªô:

| H·ªá t·ªça ƒë·ªô | M√¥ t·∫£ | Ph·∫°m vi | Ma tr·∫≠n bi·∫øn ƒë·ªïi |
|-----------|--------|---------|-------------------|
| **Model Space** | T·ªça ƒë·ªô ƒë·ªãa ph∆∞∆°ng c·ªßa object | T√πy thu·ªôc model | Model Matrix |
| **World Space** | T·ªça ƒë·ªô trong scene to√†n c·ª•c | Unlimited | View Matrix |
| **View Space** | T·ªça ƒë·ªô theo g√≥c nh√¨n camera | Camera-relative | Projection Matrix |
| **Clip Space** | T·ªça ƒë·ªô sau projection | [-1, 1] cho x,y,z | Viewport Transform |
| **Screen Space** | T·ªça ƒë·ªô pixel tr√™n m√†n h√¨nh | [0, width] √ó [0, height] | - |

---

## üî¢ Transformation Matrices - Ma tr·∫≠n bi·∫øn ƒë·ªïi

### C√°c ph√©p bi·∫øn ƒë·ªïi c∆° b·∫£n:

#### 1. Translation (T·ªãnh ti·∫øn)
```rust
// Ma tr·∫≠n t·ªãnh ti·∫øn trong Rust v·ªõi glam
let translation = Mat4::from_translation(Vec3::new(x, y, z));
```

#### 2. Rotation (Xoay)
```rust
// Xoay quanh tr·ª•c Y
let rotation = Mat4::from_rotation_y(angle_radians);
```

#### 3. Scale (T·ª∑ l·ªá)
```rust
// Thay ƒë·ªïi k√≠ch th∆∞·ªõc
let scale = Mat4::from_scale(Vec3::new(sx, sy, sz));
```

### Ma tr·∫≠n t·ªïng h·ª£p (Combined Transform):

```rust
let model_matrix = translation * rotation * scale;
```

<div className="bg-yellow-100 border-l-4 border-yellow-500 p-4 my-4">
  <div className="flex">
    <div className="flex-shrink-0">
      <span className="text-yellow-600 text-xl">‚ö†Ô∏è</span>
    </div>
    <div className="ml-3">
      <p className="text-sm text-yellow-700">
        <strong>L∆∞u √Ω quan tr·ªçng:</strong> Th·ª© t·ª± nh√¢n ma tr·∫≠n r·∫•t quan tr·ªçng! 
        Th∆∞·ªùng l√† TRS (Translation √ó Rotation √ó Scale) ƒë·ªÉ c√≥ k·∫øt qu·∫£ mong mu·ªën.
      </p>
    </div>
  </div>
</div>

---

## üíª Th·ª±c h√†nh: T·∫°o Vertex Shader v·ªõi Transform

### B∆∞·ªõc 1: Setup Material Structure

```rust
// src/materials/transform_material.rs
use bevy::prelude::*;
use bevy::render::render_resource::*;

#[derive(Asset, TypePath, AsBindGroup, Clone)]
pub struct TransformMaterial {
    #[uniform(0)]
    pub transform: TransformUniform,
    #[uniform(1)] 
    pub time: f32,
}

#[derive(Clone, Copy, Pod, Zeroable)]
#[repr(C)]
pub struct TransformUniform {
    pub model_matrix: Mat4,
    pub view_matrix: Mat4,
    pub projection_matrix: Mat4,
}
```

### B∆∞·ªõc 2: WGSL Vertex Shader

```wgsl
// assets/shaders/transform_vertex.wgsl

struct TransformUniform {
    model_matrix: mat4x4<f32>,
    view_matrix: mat4x4<f32>, 
    projection_matrix: mat4x4<f32>,
};

struct VertexInput {
    @location(0) position: vec3<f32>,
    @location(1) color: vec3<f32>,
};

struct VertexOutput {
    @builtin(position) clip_position: vec4<f32>,
    @location(0) color: vec3<f32>,
    @location(1) world_position: vec3<f32>,
};

@group(1) @binding(0)
var<uniform> transform: TransformUniform;

@group(1) @binding(1) 
var<uniform> time: f32;

@vertex
fn vs_main(input: VertexInput) -> VertexOutput {
    var out: VertexOutput;
    
    // B∆∞·ªõc 1: Model space -> World space
    let world_position = transform.model_matrix * vec4<f32>(input.position, 1.0);
    
    // B∆∞·ªõc 2: World space -> View space  
    let view_position = transform.view_matrix * world_position;
    
    // B∆∞·ªõc 3: View space -> Clip space
    out.clip_position = transform.projection_matrix * view_position;
    
    // Truy·ªÅn d·ªØ li·ªáu cho fragment shader
    out.color = input.color;
    out.world_position = world_position.xyz;
    
    return out;
}
```

---

## üé® MVP Matrix - Model View Projection

MVP Matrix l√† t√≠ch c·ªßa 3 ma tr·∫≠n bi·∫øn ƒë·ªïi ch√≠nh:

```mermaid
graph LR
    A[Vertex Position] --> B[√ó Model Matrix]
    B --> C[√ó View Matrix] 
    C --> D[√ó Projection Matrix]
    D --> E[Clip Space Position]
    
    style A fill:#e1f5fe
    style E fill:#f3e5f5
    style B fill:#fff3e0
    style C fill:#e8f5e8  
    style D fill:#fce4ec
```

### T·ªëi ∆∞u h√≥a v·ªõi MVP Matrix:

```wgsl
// Thay v√¨ nh√¢n t·ª´ng ma tr·∫≠n ri√™ng bi·ªát
let mvp_matrix = transform.projection_matrix * transform.view_matrix * transform.model_matrix;
out.clip_position = mvp_matrix * vec4<f32>(input.position, 1.0);
```

### So s√°nh hi·ªáu su·∫•t:

| Ph∆∞∆°ng ph√°p | Ph√©p nh√¢n ma tr·∫≠n | T·ªëc ƒë·ªô | Linh ho·∫°t |
|-------------|-------------------|---------|-----------|
| **T·ª´ng b∆∞·ªõc** | 3 √ó mat4√óvec4 | Ch·∫≠m h∆°n | Cao |
| **MVP Matrix** | 1 √ó mat4√óvec4 | Nhanh h∆°n | Th·∫•p h∆°n |
| **Hybrid** | 2 √ó mat4√óvec4 | C√¢n b·∫±ng | Trung b√¨nh |

---

## üöÄ T·∫°o Animation v·ªõi Vertex Transform

### Hi·ªáu ·ª©ng xoay li√™n t·ª•c:

```wgsl
@vertex
fn vs_main(input: VertexInput) -> VertexOutput {
    var out: VertexOutput;
    
    // T·∫°o ma tr·∫≠n xoay theo th·ªùi gian
    let rotation_angle = time * 1.5; // 1.5 rad/s
    let cos_a = cos(rotation_angle);
    let sin_a = sin(rotation_angle);
    
    // Ma tr·∫≠n xoay quanh tr·ª•c Y
    let rotation_matrix = mat4x4<f32>(
        cos_a, 0.0, sin_a, 0.0,
        0.0, 1.0, 0.0, 0.0,
        -sin_a, 0.0, cos_a, 0.0,
        0.0, 0.0, 0.0, 1.0
    );
    
    // √Åp d·ª•ng rotation tr∆∞·ªõc khi transform
    let rotated_position = rotation_matrix * vec4<f32>(input.position, 1.0);
    let world_position = transform.model_matrix * rotated_position;
    
    out.clip_position = transform.projection_matrix * transform.view_matrix * world_position;
    out.color = input.color;
    
    return out;
}
```

### Hi·ªáu ·ª©ng wave (s√≥ng):

```wgsl
// T·∫°o hi·ªáu ·ª©ng s√≥ng d·ªçc theo tr·ª•c Y
let wave_amplitude = 0.5;
let wave_frequency = 2.0;
let wave_speed = 3.0;

var modified_position = input.position;
modified_position.y += wave_amplitude * sin(input.position.x * wave_frequency + time * wave_speed);

let world_position = transform.model_matrix * vec4<f32>(modified_position, 1.0);
```

---

## üîß Debug v√† Troubleshooting

### C√°c l·ªói th∆∞·ªùng g·∫∑p:

<div className="bg-red-50 border border-red-200 rounded-md p-4 mb-4">
  <h4 className="text-red-800 font-semibold mb-2">‚ùå L·ªói th∆∞·ªùng g·∫∑p:</h4>
  
  <details className="mb-2">
    <summary className="cursor-pointer text-red-700 font-medium">1. Object kh√¥ng hi·ªÉn th·ªã</summary>
    <div className="mt-2 text-red-600 text-sm pl-4">
      <p><strong>Nguy√™n nh√¢n:</strong> Ma tr·∫≠n MVP kh√¥ng ƒë√∫ng ho·∫∑c object n·∫±m ngo√†i view frustum</p>
      <p><strong>Gi·∫£i ph√°p:</strong> Ki·ªÉm tra camera position v√† object bounds</p>
    </div>
  </details>
  
  <details className="mb-2">
    <summary className="cursor-pointer text-red-700 font-medium">2. Object b·ªã bi·∫øn d·∫°ng</summary>
    <div className="mt-2 text-red-600 text-sm pl-4">
      <p><strong>Nguy√™n nh√¢n:</strong> Th·ª© t·ª± nh√¢n ma tr·∫≠n sai ho·∫∑c aspect ratio kh√¥ng ƒë√∫ng</p>
      <p><strong>Gi·∫£i ph√°p:</strong> Ki·ªÉm tra order c·ªßa TRS v√† projection matrix</p>
    </div>
  </details>
</div>

### Debug techniques:

```wgsl
// Debug b·∫±ng c√°ch hi·ªÉn th·ªã position d∆∞·ªõi d·∫°ng m√†u
out.color = abs(world_position.xyz); // Chuy·ªÉn position th√†nh m√†u
```

---

## üìã B√†i t·∫≠p th·ª±c h√†nh

<div className="bg-blue-50 border border-blue-200 rounded-md p-4">
  <h4 className="text-blue-800 font-semibold mb-3">üèãÔ∏è B√†i t·∫≠p:</h4>
  
  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div className="bg-white p-3 rounded border">
      <h5 className="font-semibold mb-2">B√†i 1: Basic Transform</h5>
      <p className="text-sm text-gray-600">T·∫°o cube xoay quanh tr·ª•c Y v·ªõi t·ªëc ƒë·ªô 45¬∞/gi√¢y</p>
    </div>
    
    <div className="bg-white p-3 rounded border">
      <h5 className="font-semibold mb-2">B√†i 2: Wave Animation</h5>
      <p className="text-sm text-gray-600">T·∫°o plane v·ªõi hi·ªáu ·ª©ng s√≥ng lan truy·ªÅn</p>
    </div>
    
    <div className="bg-white p-3 rounded border">
      <h5 className="font-semibold mb-2">B√†i 3: Orbit Animation</h5>
      <p className="text-sm text-gray-600">Multiple objects quay quanh m·ªôt ƒëi·ªÉm trung t√¢m</p>
    </div>
    
    <div className="bg-white p-3 rounded border">
      <h5 className="font-semibold mb-2">B√†i 4: Scale Pulsing</h5>
      <p className="text-sm text-gray-600">Object thay ƒë·ªïi k√≠ch th∆∞·ªõc theo nh·ªãp ƒëi·ªáu</p>
    </div>
  </div>
</div>

---

## üéØ Ki·ªÉm tra hi·ªÉu bi·∫øt

### Quiz ng·∫Øn:

1. **Th·ª© t·ª± ƒë√∫ng c·ªßa transformation pipeline l√† g√¨?**
   - a) Model ‚Üí View ‚Üí World ‚Üí Clip
   - b) Model ‚Üí World ‚Üí View ‚Üí Clip  ‚úÖ
   - c) World ‚Üí Model ‚Üí View ‚Üí Clip
   - d) View ‚Üí Model ‚Üí World ‚Üí Clip

2. **MVP Matrix gi√∫p t·ªëi ∆∞u hi·ªáu su·∫•t nh∆∞ th·∫ø n√†o?**
   - a) Gi·∫£m s·ªë ph√©p nh√¢n ma tr·∫≠n t·ª´ 3 xu·ªëng 1 ‚úÖ
   - b) TƒÉng ƒë·ªô ch√≠nh x√°c t√≠nh to√°n
   - c) Gi·∫£m memory usage
   - d) TƒÉng flexibility

---

## üìö T√†i li·ªáu tham kh·∫£o

- [Bevy Transform Documentation](https://docs.rs/bevy/latest/bevy/transform/index.html)
- [WGSL Matrix Operations](https://www.w3.org/TR/WGSL/#matrix-types)
- [3D Math Primer for Graphics and Game Development](https://gamemath.com/)

---

## üîÑ Chu·∫©n b·ªã cho b√†i ti·∫øp theo

**B√†i 5: M√†u s·∫Øc v√† Interpolation** s·∫Ω bao g·ªìm:
- Color spaces v√† gamma correction  
- Vertex color interpolation
- Gradient effects v√† color mixing
- HDR color values

<div className="bg-green-100 border border-green-300 rounded-md p-4 mt-6">
  <div className="flex items-center">
    <span className="text-green-600 text-xl mr-2">‚úÖ</span>
    <p className="text-green-800 font-medium">
      Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh B√†i 4: Vertex Transformation c∆° b·∫£n
    </p>
  </div>
</div>