# BÃ i 3: Pipeline trong WebGPU - HÆ°á»›ng dáº«n chi tiáº¿t

<div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border-l-4 border-blue-500 mb-8">
  <h2 className="text-2xl font-bold text-gray-800 mb-2">ğŸ¯ Má»¥c tiÃªu bÃ i há»c</h2>
  <ul className="list-disc pl-6 text-gray-700">
    <li>Hiá»ƒu khÃ¡i niá»‡m Pipeline trong WebGPU</li>
    <li>Náº¯m vá»¯ng cÃ¡ch hoáº¡t Ä‘á»™ng cá»§a Vertex Shader vÃ  Fragment Shader</li>
    <li>Há»c cÃ¡ch viáº¿t shader báº±ng ngÃ´n ngá»¯ WGSL</li>
    <li>Táº¡o vÃ  sá»­ dá»¥ng RenderPipeline Ä‘á»ƒ váº½ hÃ¬nh tam giÃ¡c Ä‘áº§u tiÃªn</li>
  </ul>
</div>

## 1. Pipeline lÃ  gÃ¬?

<div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-6">
  <p className="text-gray-800"><strong>ğŸ’¡ KhÃ¡i niá»‡m:</strong> Pipeline trong WebGPU giá»‘ng nhÆ° má»™t dÃ¢y chuyá»n sáº£n xuáº¥t trong nhÃ  mÃ¡y. NÃ³ mÃ´ táº£ táº¥t cáº£ cÃ¡c bÆ°á»›c mÃ  GPU sáº½ thá»±c hiá»‡n khi xá»­ lÃ½ dá»¯ liá»‡u cá»§a báº¡n.</p>
</div>

Náº¿u báº¡n Ä‘Ã£ tá»«ng lÃ m viá»‡c vá»›i OpenGL vÃ  shader programs, thÃ¬ Pipeline chÃ­nh lÃ  phiÃªn báº£n máº¡nh máº½ vÃ  hoÃ n thiá»‡n hÆ¡n cá»§a khÃ¡i niá»‡m Ä‘Ã³.

### So sÃ¡nh Pipeline vs Shader Program

| Äáº·c Ä‘iá»ƒm | OpenGL Shader Program | WebGPU Pipeline |
|----------|----------------------|-----------------|
| **TÃ­nh nÄƒng** | Chá»‰ Ä‘á»‹nh nghÄ©a vertex & fragment shader | Äá»‹nh nghÄ©a toÃ n bá»™ quÃ¡ trÃ¬nh render |
| **Cáº¥u hÃ¬nh** | Háº¡n cháº¿ | TÃ¹y chá»‰nh chi tiáº¿t má»i bÆ°á»›c |
| **Hiá»‡u suáº¥t** | Tá»‘t | Tá»‘i Æ°u hÆ¡n |
| **Äá»™ phá»©c táº¡p** | ÄÆ¡n giáº£n | Phá»©c táº¡p nhÆ°ng máº¡nh máº½ |

## 2. Shader - Nhá»¯ng chÆ°Æ¡ng trÃ¬nh mini trÃªn GPU

```mermaid
graph TD
    A[Dá»¯ liá»‡u Ä‘áº§u vÃ o] --> B[Vertex Shader]
    B --> C[Primitive Assembly]
    C --> D[Rasterization]
    D --> E[Fragment Shader]
    E --> F[Framebuffer]
    
    style B fill:#e1f5fe
    style E fill:#fff3e0
    style F fill:#e8f5e8
```

### CÃ¡c loáº¡i Shader chÃ­nh

| Loáº¡i Shader | Má»¥c Ä‘Ã­ch | Dá»¯ liá»‡u xá»­ lÃ½ |
|-------------|----------|---------------|
| **Vertex Shader** | Xá»­ lÃ½ cÃ¡c Ä‘á»‰nh (vertices) | Tá»a Ä‘á»™ 3D, mÃ u sáº¯c, texture coordinates |
| **Fragment Shader** | XÃ¡c Ä‘á»‹nh mÃ u sáº¯c pixel | MÃ u sáº¯c cuá»‘i cÃ¹ng cá»§a má»—i pixel |
| **Compute Shader** | TÃ­nh toÃ¡n tá»•ng quÃ¡t | Báº¥t ká»³ dá»¯ liá»‡u nÃ o |

<div className="bg-red-50 p-4 rounded-lg border border-red-200 mb-6">
  <p className="text-red-800"><strong>âš ï¸ LÆ°u Ã½:</strong> WebGL khÃ´ng há»— trá»£ Geometry Shader vÃ  Tessellation Shader. ChÃºng thÆ°á»ng lÃ m giáº£m hiá»‡u suáº¥t nÃªn nÃªn trÃ¡nh sá»­ dá»¥ng.</p>
</div>

## 3. Vertex vÃ  Fragment - KhÃ¡i niá»‡m cÆ¡ báº£n

### 3.1 Vertex (Äá»‰nh)

<div className="bg-green-50 p-4 rounded-lg border border-green-200 mb-4">
  <p className="text-green-800"><strong>Vertex</strong> lÃ  má»™t Ä‘iá»ƒm trong khÃ´ng gian 3D (hoáº·c 2D). CÃ¡c vertex Ä‘Æ°á»£c nhÃ³m láº¡i Ä‘á»ƒ táº¡o thÃ nh:</p>
  <ul className="list-disc pl-6 mt-2">
    <li><strong>ÄÆ°á»ng tháº³ng:</strong> 2 vertex</li>
    <li><strong>Tam giÃ¡c:</strong> 3 vertex</li>
  </ul>
</div>

```mermaid
graph LR
    A[Vertex 1] --> D[Triangle]
    B[Vertex 2] --> D
    C[Vertex 3] --> D
    
    style A fill:#ffcdd2
    style B fill:#ffcdd2
    style C fill:#ffcdd2
    style D fill:#c8e6c9
```

### 3.2 QuÃ¡ trÃ¬nh Rendering

| BÆ°á»›c | MÃ´ táº£ | Shader liÃªn quan |
|------|-------|------------------|
| 1. **Vertex Processing** | Biáº¿n Ä‘á»•i tá»a Ä‘á»™ vertex | Vertex Shader |
| 2. **Primitive Assembly** | GhÃ©p vertex thÃ nh tam giÃ¡c | GPU tá»± Ä‘á»™ng |
| 3. **Rasterization** | Chuyá»ƒn tam giÃ¡c thÃ nh pixel | GPU tá»± Ä‘á»™ng |
| 4. **Fragment Processing** | TÃ´ mÃ u tá»«ng pixel | Fragment Shader |

## 4. WGSL - WebGPU Shading Language

<div className="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-6">
  <p className="text-blue-800"><strong>WGSL (WebGPU Shading Language)</strong> lÃ  ngÃ´n ngá»¯ shader chÃ­nh thá»©c cá»§a WebGPU. NÃ³ Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ dá»… dÃ ng chuyá»ƒn Ä‘á»•i sang cÃ¡c ngÃ´n ngá»¯ shader khÃ¡c nhÆ° SPIR-V, MSL, HLSL, vÃ  GLSL.</p>
</div>

### Æ¯u Ä‘iá»ƒm cá»§a WGSL

| Æ¯u Ä‘iá»ƒm | MÃ´ táº£ |
|---------|-------|
| **Äa ná»n táº£ng** | Chuyá»ƒn Ä‘á»•i tá»± Ä‘á»™ng sang ngÃ´n ngá»¯ shader cá»§a tá»«ng platform |
| **Hiá»‡u suáº¥t cao** | ÄÆ°á»£c tá»‘i Æ°u hÃ³a bá»Ÿi thÆ° viá»‡n Naga |
| **CÃº phÃ¡p rÃµ rÃ ng** | Dá»… há»c, dá»… Ä‘á»c |
| **Há»— trá»£ tá»‘t** | LÃ  ngÃ´n ngá»¯ shader chÃ­nh thá»©c cá»§a WebGPU |

## 5. Viáº¿t Shader Ä‘áº§u tiÃªn

Táº¡o file `shader.wgsl` trong cÃ¹ng thÆ° má»¥c vá»›i `main.rs`:

### 5.1 Vertex Shader

```wgsl
// Vertex shader
struct VertexOutput {
    @builtin(position) clip_position: vec4<f32>,
};

@vertex
fn vs_main(
    @builtin(vertex_index) in_vertex_index: u32,
) -> VertexOutput {
    var out: VertexOutput;
    let x = f32(1 - i32(in_vertex_index)) * 0.5;
    let y = f32(i32(in_vertex_index & 1u) * 2 - 1) * 0.5;
    out.clip_position = vec4<f32>(x, y, 0.0, 1.0);
    return out;
}
```

#### PhÃ¢n tÃ­ch tá»«ng pháº§n:

| Pháº§n | Má»¥c Ä‘Ã­ch | Giáº£i thÃ­ch |
|------|----------|------------|
| `struct VertexOutput` | Äá»‹nh nghÄ©a output cá»§a vertex shader | Chá»©a tá»a Ä‘á»™ clip_position |
| `@builtin(position)` | Chá»‰ Ä‘á»‹nh tá»a Ä‘á»™ vertex | TÆ°Æ¡ng Ä‘Æ°Æ¡ng `gl_Position` trong GLSL |
| `@vertex` | ÄÃ¡nh dáº¥u entry point | XÃ¡c Ä‘á»‹nh hÃ m vertex shader |
| `@builtin(vertex_index)` | Index cá»§a vertex hiá»‡n táº¡i | GPU tá»± Ä‘á»™ng cung cáº¥p |

<div className="bg-cyan-50 p-4 rounded-lg border border-cyan-200 mb-6">
  <h4 className="font-bold text-cyan-800 mb-2">ğŸ” PhÃ¢n tÃ­ch thuáº­t toÃ¡n táº¡o tam giÃ¡c:</h4>
  <div className="text-cyan-700">
    <p><strong>Vertex 0:</strong> x = 0.5, y = -0.5 (gÃ³c dÆ°á»›i pháº£i)</p>
    <p><strong>Vertex 1:</strong> x = -0.5, y = -0.5 (gÃ³c dÆ°á»›i trÃ¡i)</p>
    <p><strong>Vertex 2:</strong> x = 0.5, y = 0.5 (gÃ³c trÃªn pháº£i)</p>
  </div>
</div>

### 5.2 Fragment Shader

```wgsl
// Fragment shader
@fragment
fn fs_main(in: VertexOutput) -> @location(0) vec4<f32> {
    return vec4<f32>(0.3, 0.2, 0.1, 1.0);
}
```

#### PhÃ¢n tÃ­ch Fragment Shader:

| ThÃ nh pháº§n | GiÃ¡ trá»‹ | Ã nghÄ©a |
|------------|---------|---------|
| `@fragment` | - | ÄÃ¡nh dáº¥u entry point cho fragment shader |
| `@location(0)` | - | Xuáº¥t ra color target Ä‘áº§u tiÃªn |
| `vec4<f32>(0.3, 0.2, 0.1, 1.0)` | RGBA | MÃ u nÃ¢u (Red=0.3, Green=0.2, Blue=0.1, Alpha=1.0) |

## 6. Táº¡o RenderPipeline

### 6.1 Cáº­p nháº­t struct State

```rust
pub struct State {
    surface: wgpu::Surface<'static>,
    device: wgpu::Device,
    queue: wgpu::Queue,
    config: wgpu::SurfaceConfiguration,
    is_surface_configured: bool,
    // Má»šI!
    render_pipeline: wgpu::RenderPipeline,
    window: Arc<Window>,
}
```

### 6.2 Load Shader Module

```rust
let shader = device.create_shader_module(wgpu::ShaderModuleDescriptor {
    label: Some("Shader"),
    source: wgpu::ShaderSource::Wgsl(include_str!("shader.wgsl").into()),
});

// Hoáº·c sá»­ dá»¥ng macro ngáº¯n gá»n hÆ¡n:
// let shader = device.create_shader_module(wgpu::include_wgsl!("shader.wgsl"));
```

### 6.3 Táº¡o Pipeline Layout

```rust
let render_pipeline_layout = device.create_pipeline_layout(&wgpu::PipelineLayoutDescriptor {
    label: Some("Render Pipeline Layout"),
    bind_group_layouts: &[],
    push_constant_ranges: &[],
});
```

### 6.4 Táº¡o RenderPipeline

```mermaid
flowchart TD
    A[ShaderModule] --> B[PipelineLayout]
    B --> C[RenderPipeline]
    D[VertexState] --> C
    E[FragmentState] --> C
    F[PrimitiveState] --> C
    G[MultisampleState] --> C
    
    style C fill:#e8f5e8
```

#### Vertex State Configuration

```rust
vertex: wgpu::VertexState {
    module: &shader,
    entry_point: Some("vs_main"),
    buffers: &[],
    compilation_options: wgpu::PipelineCompilationOptions::default(),
},
```

| Tham sá»‘ | GiÃ¡ trá»‹ | Má»¥c Ä‘Ã­ch |
|---------|---------|----------|
| `module` | `&shader` | Shader module chá»©a vertex shader |
| `entry_point` | `"vs_main"` | TÃªn hÃ m vertex shader |
| `buffers` | `&[]` | Danh sÃ¡ch vertex buffer (Ä‘á»ƒ trá»‘ng vÃ¬ dÃ¹ng built-in) |

#### Fragment State Configuration

```rust
fragment: Some(wgpu::FragmentState {
    module: &shader,
    entry_point: Some("fs_main"),
    targets: &[Some(wgpu::ColorTargetState {
        format: config.format,
        blend: Some(wgpu::BlendState::REPLACE),
        write_mask: wgpu::ColorWrites::ALL,
    })],
    compilation_options: wgpu::PipelineCompilationOptions::default(),
}),
```

##### Color Target State - Báº£ng cáº¥u hÃ¬nh

| Thuá»™c tÃ­nh | GiÃ¡ trá»‹ | Ã nghÄ©a |
|------------|---------|---------|
| `format` | `config.format` | Äá»‹nh dáº¡ng pixel giá»‘ng surface |
| `blend` | `REPLACE` | Thay tháº¿ hoÃ n toÃ n pixel cÅ© |
| `write_mask` | `ALL` | Ghi táº¥t cáº£ kÃªnh mÃ u (RGBA) |

#### Primitive State Configuration

```rust
primitive: wgpu::PrimitiveState {
    topology: wgpu::PrimitiveTopology::TriangleList,
    strip_index_format: None,
    front_face: wgpu::FrontFace::Ccw,
    cull_mode: Some(wgpu::Face::Back),
    polygon_mode: wgpu::PolygonMode::Fill,
    unclipped_depth: false,
    conservative: false,
},
```

##### Primitive State - Báº£ng chi tiáº¿t

| Thuá»™c tÃ­nh | GiÃ¡ trá»‹ | MÃ´ táº£ |
|------------|---------|-------|
| `topology` | `TriangleList` | Má»—i 3 vertex táº¡o thÃ nh 1 tam giÃ¡c |
| `front_face` | `Ccw` | Tam giÃ¡c cÃ³ vertex xáº¿p ngÆ°á»£c chiá»u kim Ä‘á»“ng há»“ lÃ  máº·t trÆ°á»›c |
| `cull_mode` | `Back` | Loáº¡i bá» máº·t sau |
| `polygon_mode` | `Fill` | TÃ´ Ä‘áº§y tam giÃ¡c |

#### Cáº¥u hÃ¬nh cÃ²n láº¡i

```rust
depth_stencil: None,
multisample: wgpu::MultisampleState {
    count: 1,
    mask: !0,
    alpha_to_coverage_enabled: false,
},
multiview: None,
cache: None,
```

| Cáº¥u hÃ¬nh | Má»¥c Ä‘Ã­ch | GiÃ¡ trá»‹ hiá»‡n táº¡i |
|----------|----------|------------------|
| `depth_stencil` | Depth testing | `None` (chÆ°a dÃ¹ng) |
| `multisample.count` | Sá»‘ lÆ°á»£ng sample | 1 (khÃ´ng multisampling) |
| `multiview` | Array texture layers | `None` |
| `cache` | Cache shader compilation | `None` |

## 7. Sá»­ dá»¥ng Pipeline trong Render

### 7.1 Cáº­p nháº­t hÃ m render()

```rust
// render()
{
    let mut render_pass = encoder.begin_render_pass(&wgpu::RenderPassDescriptor {
        label: Some("Render Pass"),
        color_attachments: &[
            Some(wgpu::RenderPassColorAttachment {
                view: &view,
                resolve_target: None,
                ops: wgpu::Operations {
                    load: wgpu::LoadOp::Clear(wgpu::Color {
                        r: 0.1,
                        g: 0.2,
                        b: 0.3,
                        a: 1.0,
                    }),
                    store: wgpu::StoreOp::Store,
                }
            })
        ],
        depth_stencil_attachment: None,
    });

    // Sá»¬ Dá»¤NG PIPELINE
    render_pass.set_pipeline(&self.render_pipeline);
    render_pass.draw(0..3, 0..1);
}
```

### 7.2 PhÃ¢n tÃ­ch lá»‡nh draw

```mermaid
graph LR
    A[render_pass.draw] --> B[Vertex range: 0..3]
    A --> C[Instance range: 0..1]
    B --> D[3 vertices â†’ 1 triangle]
    C --> E[1 instance]
```

| Tham sá»‘ | GiÃ¡ trá»‹ | Ã nghÄ©a |
|---------|---------|---------|
| Vertex range | `0..3` | Váº½ 3 vertex (index 0, 1, 2) |
| Instance range | `0..1` | Váº½ 1 instance cá»§a geometry |

<div className="bg-green-50 p-6 rounded-lg border border-green-200 mt-8">
  <h3 className="text-xl font-bold text-green-800 mb-4">ğŸ‰ Káº¿t quáº£</h3>
  <p className="text-green-700">Sau khi cháº¡y code, báº¡n sáº½ tháº¥y má»™t tam giÃ¡c mÃ u nÃ¢u xuáº¥t hiá»‡n trÃªn mÃ n hÃ¬nh!</p>
</div>

## 8. BÃ i táº­p thá»­ thÃ¡ch

<div className="bg-orange-50 p-6 rounded-lg border border-orange-200 mt-8">
  <h3 className="text-xl font-bold text-orange-800 mb-4">ğŸš€ Thá»­ thÃ¡ch</h3>
  <p className="text-orange-700 mb-4">Táº¡o má»™t pipeline thá»© hai sá»­ dá»¥ng dá»¯ liá»‡u vá»‹ trÃ­ cá»§a tam giÃ¡c Ä‘á»ƒ táº¡o mÃ u sáº¯c, sau Ä‘Ã³ gá»­i mÃ u nÃ y Ä‘áº¿n fragment shader. Cho phÃ©p á»©ng dá»¥ng chuyá»ƒn Ä‘á»•i giá»¯a hai pipeline khi nháº¥n phÃ­m space.</p>
  
  <div className="bg-white p-4 rounded border-l-4 border-orange-400 mt-4">
    <p className="font-semibold text-orange-800">ğŸ’¡ Gá»£i Ã½:</p>
    <ul className="list-disc pl-6 text-orange-700">
      <li>Báº¡n cáº§n sá»­a Ä‘á»•i struct <code>VertexOutput</code></li>
      <li>ThÃªm trÆ°á»ng má»›i Ä‘á»ƒ truyá»n mÃ u sáº¯c tá»« vertex shader sang fragment shader</li>
      <li>Sá»­ dá»¥ng <code>@location(n)</code> Ä‘á»ƒ Ä‘á»‹nh nghÄ©a cÃ¡c trÆ°á»ng tÃ¹y chá»‰nh</li>
    </ul>
  </div>
</div>

### Cáº¥u trÃºc VertexOutput má»Ÿ rá»™ng:

```rust
struct VertexOutput {
    @builtin(position) clip_position: vec4<f32>,
    @location(0) vert_pos: vec3<f32>,  // Vá»‹ trÃ­ vertex
    @location(1) color: vec3<f32>,     // MÃ u sáº¯c
}
```

## 9. Tá»•ng káº¿t

### Nhá»¯ng kiáº¿n thá»©c Ä‘Ã£ há»c:

- âœ… **Pipeline:** Chuá»—i xá»­ lÃ½ dá»¯ liá»‡u trÃªn GPU  
- âœ… **WGSL:** NgÃ´n ngá»¯ shader cá»§a WebGPU  
- âœ… **Vertex Shader:** Xá»­ lÃ½ tá»a Ä‘á»™ vertex  
- âœ… **Fragment Shader:** XÃ¡c Ä‘á»‹nh mÃ u sáº¯c pixel  
- âœ… **RenderPipeline:** Cáº¥u hÃ¬nh complete pipeline  
- âœ… **Render Pass:** Sá»­ dá»¥ng pipeline Ä‘á»ƒ váº½  

### BÆ°á»›c tiáº¿p theo:

Trong bÃ i há»c tiáº¿p theo, chÃºng ta sáº½ tÃ¬m hiá»ƒu vá» **Buffer** - cÃ¡ch lÆ°u trá»¯ vÃ  truyá»n dá»¯ liá»‡u vertex tá»« CPU sang GPU má»™t cÃ¡ch hiá»‡u quáº£.

<div className="bg-gray-50 p-4 rounded-lg border border-gray-200 mt-8 text-center">
  <span className="text-gray-600 italic">
    "Má»—i tam giÃ¡c Ä‘á»u báº¯t Ä‘áº§u tá»« ba Ä‘iá»ƒm. HÃ nh trÃ¬nh graphics programming cá»§a báº¡n cÅ©ng váº­y!" ğŸ”º
  </span>
</div>