# BÃ i 2: Surface vÃ  Rendering cÆ¡ báº£n

<div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-lg mb-6">
<h2 className="text-2xl font-bold mb-2">ğŸ¯ Má»¥c tiÃªu bÃ i há»c</h2>
<p className="text-lg">Há»c cÃ¡ch táº¡o Surface, cáº¥u hÃ¬nh Device vÃ  Queue, vÃ  thá»±c hiá»‡n rendering Ä‘áº§u tiÃªn vá»›i WGPU</p>
</div>

## ğŸ“‹ Tá»•ng quan vá» Surface

**Surface** lÃ  thÃ nh pháº§n quan trá»ng nháº¥t trong WGPU, Ä‘Ã³ng vai trÃ² nhÆ° má»™t cáº§u ná»‘i giá»¯a á»©ng dá»¥ng vÃ  mÃ n hÃ¬nh hiá»ƒn thá»‹.

<div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
<h3 className="text-lg font-semibold text-yellow-800 mb-2">ğŸ’¡ KhÃ¡i niá»‡m cá»‘t lÃµi</h3>
<p className="text-yellow-700">Surface lÃ  pháº§n cá»§a cá»­a sá»• mÃ  chÃºng ta váº½ lÃªn. NÃ³ cáº§n thiáº¿t Ä‘á»ƒ váº½ trá»±c tiáº¿p lÃªn mÃ n hÃ¬nh.</p>
</div>

## ğŸ—ï¸ Cáº¥u trÃºc State cÆ¡ báº£n

TrÆ°á»›c tiÃªn, hÃ£y xem xÃ©t cáº¥u trÃºc `State` mÃ  chÃºng ta sáº½ sá»­ dá»¥ng:

```rust
pub struct State {
    surface: wgpu::Surface<'static>,
    device: wgpu::Device,
    queue: wgpu::Queue,
    config: wgpu::SurfaceConfiguration,
    is_surface_configured: bool,
    window: Arc<Window>,
}
```

### ğŸ“Š Báº£ng mÃ´ táº£ cÃ¡c thÃ nh pháº§n State

| ThÃ nh pháº§n | Kiá»ƒu dá»¯ liá»‡u | MÃ´ táº£ | Vai trÃ² |
|------------|--------------|-------|---------|
| `surface` | `wgpu::Surface<'static>` | Bá» máº·t váº½ | NÆ¡i hiá»ƒn thá»‹ káº¿t quáº£ rendering |
| `device` | `wgpu::Device` | Thiáº¿t bá»‹ GPU | Táº¡o tÃ i nguyÃªn vÃ  thá»±c thi lá»‡nh |
| `queue` | `wgpu::Queue` | HÃ ng Ä‘á»£i lá»‡nh | Gá»­i lá»‡nh Ä‘áº¿n GPU |
| `config` | `wgpu::SurfaceConfiguration` | Cáº¥u hÃ¬nh surface | Äá»‹nh nghÄ©a cÃ¡ch surface hoáº¡t Ä‘á»™ng |
| `is_surface_configured` | `bool` | Tráº¡ng thÃ¡i cáº¥u hÃ¬nh | Kiá»ƒm tra surface Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh |
| `window` | `Arc<Window>` | Cá»­a sá»• á»©ng dá»¥ng | Tham chiáº¿u Ä‘áº¿n cá»­a sá»• hiá»ƒn thá»‹ |

## ğŸ”§ Khá»Ÿi táº¡o State - PhÆ°Æ¡ng thá»©c `new()`

### SÆ¡ Ä‘á»“ quy trÃ¬nh khá»Ÿi táº¡o

```mermaid
flowchart TD
    A[Táº¡o Instance] --> B[Táº¡o Surface]
    B --> C[Request Adapter]
    C --> D[Request Device & Queue]
    D --> E[Cáº¥u hÃ¬nh Surface]
    E --> F[Táº¡o State]
```

### BÆ°á»›c 1: Táº¡o Instance vÃ  Surface

```rust
async fn new(window: Arc<Window>) -> anyhow::Result<State> {
    let size = window.inner_size();

    // Instance lÃ  handle Ä‘áº¿n GPU
    let instance = wgpu::Instance::new(&wgpu::InstanceDescriptor {
        #[cfg(not(target_arch = "wasm32"))]
        backends: wgpu::Backends::PRIMARY,
        #[cfg(target_arch = "wasm32")]
        backends: wgpu::Backends::GL,
        ..Default::default()
    });

    let surface = instance.create_surface(window.clone()).unwrap();
    // ...
}
```

<div className="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
<h4 className="text-lg font-semibold text-blue-800 mb-2">ğŸ“ Giáº£i thÃ­ch Instance</h4>
<ul className="text-blue-700 space-y-1">
<li><strong>Instance:</strong> Äiá»ƒm khá»Ÿi Ä‘áº§u khi sá»­ dá»¥ng WGPU</li>
<li><strong>Má»¥c Ä‘Ã­ch:</strong> Táº¡o Adapters vÃ  Surfaces</li>
<li><strong>Backends:</strong> Há»— trá»£ Vulkan, Metal, DX12, WebGPU</li>
</ul>
</div>

### BÆ°á»›c 2: Request Adapter

```rust
let adapter = instance
    .request_adapter(&wgpu::RequestAdapterOptions {
        power_preference: wgpu::PowerPreference::default(),
        compatible_surface: Some(&surface),
        force_fallback_adapter: false,
    })
    .await?;
```

### ğŸ“Š Báº£ng mÃ´ táº£ RequestAdapterOptions

| Tham sá»‘ | Kiá»ƒu | MÃ´ táº£ | GiÃ¡ trá»‹ khuyáº¿n nghá»‹ |
|---------|------|-------|---------------------|
| `power_preference` | `PowerPreference` | Æ¯u tiÃªn hiá»‡u nÄƒng hay tiáº¿t kiá»‡m pin | `default()` |
| `compatible_surface` | `Option<&Surface>` | Surface tÆ°Æ¡ng thÃ­ch | `Some(&surface)` |
| `force_fallback_adapter` | `bool` | Báº¯t buá»™c dÃ¹ng software rendering | `false` |

<div className="bg-green-50 border-l-4 border-green-400 p-4 mb-4">
<h4 className="text-lg font-semibold text-green-800 mb-2">ğŸ’š PowerPreference Options</h4>
<ul className="text-green-700 space-y-1">
<li><strong>LowPower:</strong> Æ¯u tiÃªn tiáº¿t kiá»‡m pin (GPU tÃ­ch há»£p)</li>
<li><strong>HighPerformance:</strong> Æ¯u tiÃªn hiá»‡u nÄƒng (GPU rá»i)</li>
<li><strong>Default:</strong> Äá»ƒ WGPU tá»± chá»n phÃ¹ há»£p</li>
</ul>
</div>

### BÆ°á»›c 3: Táº¡o Device vÃ  Queue

```rust
let (device, queue) = adapter
    .request_device(&wgpu::DeviceDescriptor {
        label: None,
        required_features: wgpu::Features::empty(),
        required_limits: if cfg!(target_arch = "wasm32") {
            wgpu::Limits::downlevel_webgl2_defaults()
        } else {
            wgpu::Limits::default()
        },
        memory_hints: Default::default(),
        trace: wgpu::Trace::Off,
    })
    .await?;
```

### ğŸ“Š Báº£ng cáº¥u hÃ¬nh Device

| Tham sá»‘ | MÃ´ táº£ | GiÃ¡ trá»‹ máº·c Ä‘á»‹nh | Ghi chÃº |
|---------|-------|------------------|---------|
| `label` | NhÃ£n debug | `None` | Há»¯u Ã­ch khi debug |
| `required_features` | TÃ­nh nÄƒng yÃªu cáº§u | `empty()` | Kiá»ƒm tra kháº£ nÄƒng há»— trá»£ |
| `required_limits` | Giá»›i háº¡n tÃ i nguyÃªn | Platform dependent | WebGL cÃ³ giá»›i háº¡n kháº¯t khe hÆ¡n |
| `memory_hints` | Gá»£i Ã½ quáº£n lÃ½ bá»™ nhá»› | `Default` | Tá»‘i Æ°u hÃ³a bá»™ nhá»› |

### BÆ°á»›c 4: Cáº¥u hÃ¬nh Surface

```rust
let surface_caps = surface.get_capabilities(&adapter);
let surface_format = surface_caps.formats.iter()
    .find(|f| f.is_srgb())
    .copied()
    .unwrap_or(surface_caps.formats[0]);

let config = wgpu::SurfaceConfiguration {
    usage: wgpu::TextureUsages::RENDER_ATTACHMENT,
    format: surface_format,
    width: size.width,
    height: size.height,
    present_mode: surface_caps.present_modes[0],
    alpha_mode: surface_caps.alpha_modes[0],
    view_formats: vec![],
    desired_maximum_frame_latency: 2,
};
```

### ğŸ“Š Báº£ng cáº¥u hÃ¬nh SurfaceConfiguration

| Tham sá»‘ | MÃ´ táº£ | Ã nghÄ©a |
|---------|-------|---------|
| `usage` | CÃ¡ch sá»­ dá»¥ng texture | `RENDER_ATTACHMENT` = váº½ lÃªn mÃ n hÃ¬nh |
| `format` | Äá»‹nh dáº¡ng mÃ u | sRGB Ä‘Æ°á»£c Æ°u tiÃªn |
| `width/height` | KÃ­ch thÆ°á»›c | Theo kÃ­ch thÆ°á»›c cá»­a sá»• |
| `present_mode` | Cháº¿ Ä‘á»™ hiá»ƒn thá»‹ | VSync vÃ  frame rate |
| `alpha_mode` | Cháº¿ Ä‘á»™ trong suá»‘t | Xá»­ lÃ½ kÃªnh alpha |
| `view_formats` | Äá»‹nh dáº¡ng view | Chuyá»ƒn Ä‘á»•i khÃ´ng gian mÃ u |

<div className="bg-red-50 border-l-4 border-red-400 p-4 mb-4">
<h4 className="text-lg font-semibold text-red-800 mb-2">âš ï¸ LÆ°u Ã½ quan trá»ng</h4>
<p className="text-red-700">Äáº£m báº£o width vÃ  height khÃ´ng báº±ng 0, vÃ¬ Ä‘iá»u nÃ y cÃ³ thá»ƒ lÃ m crash á»©ng dá»¥ng!</p>
</div>

## ğŸ”„ Xá»­ lÃ½ thay Ä‘á»•i kÃ­ch thÆ°á»›c - `resize()`

```rust
pub fn resize(&mut self, width: u32, height: u32) {
    if width > 0 && height > 0 {
        self.config.width = width;
        self.config.height = height;
        self.surface.configure(&self.device, &self.config);
        self.is_surface_configured = true;
    }
}
```

### SÆ¡ Ä‘á»“ quy trÃ¬nh resize

```mermaid
flowchart LR
    A[Kiá»ƒm tra kÃ­ch thÆ°á»›c > 0] --> B[Cáº­p nháº­t config]
    B --> C[Cáº¥u hÃ¬nh láº¡i surface]
    C --> D[ÄÃ¡nh dáº¥u Ä‘Ã£ cáº¥u hÃ¬nh]
```

## âŒ¨ï¸ Xá»­ lÃ½ sá»± kiá»‡n bÃ n phÃ­m - `handle_key()`

```rust
fn handle_key(&self, event_loop: &ActiveEventLoop, code: KeyCode, is_pressed: bool) {
    match (code, is_pressed) {
        (KeyCode::Escape, true) => event_loop.exit(),
        _ => {}
    }
}
```

### ğŸ“Š Báº£ng xá»­ lÃ½ phÃ­m táº¯t

| PhÃ­m | Tráº¡ng thÃ¡i | HÃ nh Ä‘á»™ng | MÃ´ táº£ |
|------|------------|-----------|-------|
| `Escape` | Nháº¥n | ThoÃ¡t á»©ng dá»¥ng | Káº¿t thÃºc event loop |
| KhÃ¡c | - | KhÃ´ng lÃ m gÃ¬ | Dá»± trá»¯ cho tÆ°Æ¡ng lai |

## ğŸ¨ Rendering - PhÆ°Æ¡ng thá»©c `render()`

ÄÃ¢y lÃ  pháº§n quan trá»ng nháº¥t - nÆ¡i diá»…n ra quÃ¡ trÃ¬nh váº½!

### SÆ¡ Ä‘á»“ quy trÃ¬nh rendering

```mermaid
flowchart TD
    A[Request Redraw] --> B{Surface Ä‘Ã£ cáº¥u hÃ¬nh?}
    B -->|KhÃ´ng| C[Return OK]
    B -->|CÃ³| D[Get Current Texture]
    D --> E[Táº¡o TextureView]
    E --> F[Táº¡o CommandEncoder]
    F --> G[Begin RenderPass]
    G --> H[Clear Screen]
    H --> I[Submit Commands]
    I --> J[Present Frame]
```

### BÆ°á»›c 1: Kiá»ƒm tra vÃ  láº¥y texture

```rust
fn render(&mut self) -> Result<(), wgpu::SurfaceError> {
    self.window.request_redraw();

    // KhÃ´ng thá»ƒ render náº¿u surface chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh
    if !self.is_surface_configured {
        return Ok(());
    }
        
    let output = self.surface.get_current_texture()?;
    let view = output.texture.create_view(&wgpu::TextureViewDescriptor::default());
```

### BÆ°á»›c 2: Táº¡o CommandEncoder

```rust
let mut encoder = self.device.create_command_encoder(&wgpu::CommandEncoderDescriptor {
    label: Some("Render Encoder"),
});
```

<div className="bg-purple-50 border-l-4 border-purple-400 p-4 mb-4">
<h4 className="text-lg font-semibold text-purple-800 mb-2">ğŸ¯ CommandEncoder</h4>
<p className="text-purple-700">Táº¡o buffer lá»‡nh Ä‘á»ƒ gá»­i Ä‘áº¿n GPU. Háº§u háº¿t cÃ¡c framework Ä‘á»“ há»a hiá»‡n Ä‘áº¡i Ä‘á»u yÃªu cáº§u lá»‡nh Ä‘Æ°á»£c lÆ°u trá»¯ trong buffer trÆ°á»›c khi gá»­i Ä‘áº¿n GPU.</p>
</div>

### BÆ°á»›c 3: Táº¡o RenderPass vÃ  Clear Screen

```rust
{
    let _render_pass = encoder.begin_render_pass(&wgpu::RenderPassDescriptor {
        label: Some("Render Pass"),
        color_attachments: &[Some(wgpu::RenderPassColorAttachment {
            view: &view,
            resolve_target: None,
            ops: wgpu::Operations {
                load: wgpu::LoadOp::Clear(wgpu::Color {
                    r: 0.1,
                    g: 0.2,
                    b: 0.3,
                    a: 1.0,
                }),
                store: wgpu::StoreOp::Store,
            },
        })],
        depth_stencil_attachment: None,
        occlusion_query_set: None,
        timestamp_writes: None,
    });
}

// Submit commands vÃ  present frame
self.queue.submit(std::iter::once(encoder.finish()));
output.present();

Ok(())
```

### ğŸ“Š Báº£ng phÃ¢n tÃ­ch RenderPassDescriptor

| ThÃ nh pháº§n | Kiá»ƒu | MÃ´ táº£ | VÃ­ dá»¥ |
|------------|------|-------|-------|
| `label` | `Option<&str>` | NhÃ£n debug | `"Render Pass"` |
| `color_attachments` | `&[Option<RenderPassColorAttachment>]` | NÆ¡i váº½ mÃ u | Texture view |
| `depth_stencil_attachment` | `Option<...>` | Buffer Ä‘á»™ sÃ¢u | `None` (chÆ°a dÃ¹ng) |

### ğŸ“Š Báº£ng phÃ¢n tÃ­ch RenderPassColorAttachment

| Tham sá»‘ | MÃ´ táº£ | GiÃ¡ trá»‹ | Ã nghÄ©a |
|---------|-------|---------|---------|
| `view` | TextureView Ä‘Ã­ch | `&view` | NÆ¡i váº½ (mÃ n hÃ¬nh) |
| `resolve_target` | Target multisampling | `None` | KhÃ´ng dÃ¹ng MSAA |
| `load` | Xá»­ lÃ½ mÃ u cÅ© | `Clear(color)` | XÃ³a vá»›i mÃ u xanh |
| `store` | LÆ°u káº¿t quáº£ | `Store` | LÆ°u vÃ o texture |

<div className="bg-indigo-50 border-l-4 border-indigo-400 p-4 mb-4">
<h4 className="text-lg font-semibold text-indigo-800 mb-2">ğŸ” Giáº£i thÃ­ch Load Operations</h4>
<ul className="text-indigo-700 space-y-1">
<li><strong>Clear:</strong> XÃ³a vá»›i mÃ u chá»‰ Ä‘á»‹nh</li>
<li><strong>Load:</strong> Giá»¯ nguyÃªn ná»™i dung cÅ©</li>
<li><strong>DontCare:</strong> KhÃ´ng quan tÃ¢m ná»™i dung cÅ©</li>
</ul>
</div>

## ğŸ® TÃ­ch há»£p vÃ o Event Loop

Cáº­p nháº­t phÆ°Æ¡ng thá»©c `window_event()` trong `App`:

```rust
fn window_event(
    &mut self,
    event_loop: &ActiveEventLoop,
    _window_id: winit::window::WindowId,
    event: WindowEvent,
) {
    let state = match &mut self.state {
        Some(state) => state,
        None => return,
    };

    match event {
        WindowEvent::KeyboardInput {
            event: KeyEvent {
                physical_key: PhysicalKey::Code(code),
                state: key_state,
                ..
            },
            ..
        } => state.handle_key(event_loop, code, key_state.is_pressed()),
        
        WindowEvent::RedrawRequested => {
            state.update();
            match state.render() {
                Ok(_) => {}
                Err(wgpu::SurfaceError::Lost | wgpu::SurfaceError::Outdated) => {
                    let size = state.window.inner_size();
                    state.resize(size.width, size.height);
                }
                Err(e) => {
                    log::error!("Unable to render {}", e);
                }
            }
        }
        _ => {}
    }
}
```

### ğŸ“Š Báº£ng xá»­ lÃ½ lá»—i Surface

| Lá»—i | NguyÃªn nhÃ¢n | Xá»­ lÃ½ | Káº¿t quáº£ |
|-----|-------------|-------|---------|
| `Lost` | Surface bá»‹ máº¥t | Resize láº¡i | KhÃ´i phá»¥c surface |
| `Outdated` | Surface lá»—i thá»i | Resize láº¡i | Cáº­p nháº­t surface |
| KhÃ¡c | Lá»—i há»‡ thá»‘ng | Log error | ThÃ´ng bÃ¡o lá»—i |

## ğŸ¨ Káº¿t quáº£ mong Ä‘á»£i

Sau khi hoÃ n thÃ nh, báº¡n sáº½ tháº¥y má»™t cá»­a sá»• vá»›i ná»n mÃ u xanh Ä‘áº­m:

<div className="bg-gradient-to-br from-blue-800 to-blue-600 h-32 rounded-lg flex items-center justify-center text-white font-semibold text-xl">
Cá»­a sá»• vá»›i ná»n mÃ u xanh (RGB: 0.1, 0.2, 0.3)
</div>

## ğŸ”§ Kháº¯c phá»¥c sá»± cá»‘ thÆ°á»ng gáº·p

### ğŸ“Š Báº£ng cÃ¡c lá»—i thÆ°á»ng gáº·p

| Váº¥n Ä‘á» | Triá»‡u chá»©ng | NguyÃªn nhÃ¢n | Giáº£i phÃ¡p |
|--------|-------------|-------------|-----------|
| Validation Errors | Lá»—i khi cháº¡y | Vulkan SDK cÅ© | Cáº­p nháº­t SDK >= 1.2.182 |
| Crash khi resize | App Ä‘Ã³ng Ä‘á»™t ngá»™t | Width/Height = 0 | Kiá»ƒm tra > 0 |
| MÃ n hÃ¬nh Ä‘en | KhÃ´ng hiá»ƒn thá»‹ gÃ¬ | Surface chÆ°a cáº¥u hÃ¬nh | Gá»i resize() |
| MÃ u sai | MÃ u khÃ´ng nhÆ° mong Ä‘á»£i | Format khÃ´ng sRGB | Chá»n format sRGB |

## ğŸ’» BÃ i táº­p thá»±c hÃ nh

<div className="bg-orange-50 border-l-4 border-orange-400 p-4 mb-4">
<h3 className="text-lg font-semibold text-orange-800 mb-2">ğŸ¯ Thá»­ thÃ¡ch</h3>
<p className="text-orange-700">Táº¡o phÆ°Æ¡ng thá»©c <code>handle_mouse_moved()</code> Ä‘á»ƒ báº¯t sá»± kiá»‡n chuá»™t vÃ  thay Ä‘á»•i mÃ u clear dá»±a trÃªn vá»‹ trÃ­ chuá»™t.</p>
<p className="text-orange-700 mt-2"><strong>Gá»£i Ã½:</strong> Sá»­ dá»¥ng <code>WindowEvent::CursorMoved</code></p>
</div>

### HÆ°á»›ng dáº«n thá»±c hiá»‡n:

1. **ThÃªm trÆ°á»ng lÆ°u mÃ u:**
```rust
pub struct State {
    // ... cÃ¡c trÆ°á»ng khÃ¡c
    clear_color: wgpu::Color,
}
```

2. **Táº¡o phÆ°Æ¡ng thá»©c xá»­ lÃ½ chuá»™t:**
```rust
fn handle_mouse_moved(&mut self, position: PhysicalPosition<f64>, size: PhysicalSize<u32>) {
    // Chuyá»ƒn Ä‘á»•i tá»a Ä‘á»™ chuá»™t thÃ nh mÃ u RGB
    let r = (position.x / size.width as f64) as f32;
    let g = (position.y / size.height as f64) as f32;
    let b = 0.5;
    
    self.clear_color = wgpu::Color { r, g, b, a: 1.0 };
}
```

3. **Cáº­p nháº­t render() Ä‘á»ƒ sá»­ dá»¥ng mÃ u Ä‘á»™ng:**
```rust
load: wgpu::LoadOp::Clear(self.clear_color),
```

## ğŸ“š Tá»•ng káº¿t

<div className="bg-green-100 border border-green-400 rounded-lg p-6">
<h3 className="text-xl font-bold text-green-800 mb-4">âœ… Kiáº¿n thá»©c Ä‘Ã£ há»c</h3>
<div className="grid md:grid-cols-2 gap-4">
<div className="bg-white p-4 rounded border">
<h4 className="font-semibold text-green-700 mb-2">KhÃ¡i niá»‡m cá»‘t lÃµi:</h4>
<ul className="text-green-600 space-y-1">
<li>â€¢ Instance vÃ  Adapter</li>
<li>â€¢ Device vÃ  Queue</li>
<li>â€¢ Surface vÃ  Texture</li>
<li>â€¢ CommandEncoder</li>
</ul>
</div>
<div className="bg-white p-4 rounded border">
<h4 className="font-semibold text-green-700 mb-2">Ká»¹ nÄƒng thá»±c hÃ nh:</h4>
<ul className="text-green-600 space-y-1">
<li>â€¢ Khá»Ÿi táº¡o WGPU pipeline</li>
<li>â€¢ Cáº¥u hÃ¬nh Surface</li>
<li>â€¢ Xá»­ lÃ½ sá»± kiá»‡n</li>
<li>â€¢ Rendering cÆ¡ báº£n</li>
</ul>
</div>
</div>
</div>

### Chuáº©n bá»‹ cho bÃ i tiáº¿p theo

Trong bÃ i tiáº¿p theo, chÃºng ta sáº½ há»c vá»:
- ğŸ¨ **Shaders**: Viáº¿t code cháº¡y trÃªn GPU
- ğŸ”º **Vertices**: Váº½ cÃ¡c hÃ¬nh há»c cÆ¡ báº£n
- ğŸ­ **Render Pipelines**: Tá»‘i Æ°u hÃ³a rendering

<div className="text-center p-6 bg-gray-50 rounded-lg">
<p className="text-lg font-medium text-gray-700">ğŸ‰ ChÃºc má»«ng báº¡n Ä‘Ã£ hoÃ n thÃ nh BÃ i 2!</p>
<p className="text-gray-600 mt-2">HÃ£y thá»±c hÃ nh bÃ i táº­p Ä‘á»ƒ cá»§ng cá»‘ kiáº¿n thá»©c nhÃ©!</p>
</div>