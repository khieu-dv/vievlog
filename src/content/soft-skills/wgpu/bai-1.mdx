# B√†i 1: T·∫°o C·ª≠a S·ªï v√† Thi·∫øt L·∫≠p M√¥i Tr∆∞·ªùng WGPU

<div className="bg-gradient-to-r from-blue-50 to-indigo-100 p-6 rounded-lg border-l-4 border-blue-500 mb-6">
  <h2 className="text-2xl font-bold text-blue-800 mb-2">üéØ M·ª•c Ti√™u B√†i H·ªçc</h2>
  <p className="text-gray-700">Trong b√†i h·ªçc n√†y, ch√∫ng ta s·∫Ω h·ªçc c√°ch t·∫°o m·ªôt c·ª≠a s·ªï c∆° b·∫£n s·ª≠ d·ª•ng th∆∞ vi·ªán <strong>winit</strong> v√† thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng ƒë·ªÉ s·ª≠ d·ª•ng <strong>WGPU</strong>. ƒê√¢y l√† b∆∞·ªõc ƒë·∫ßu ti√™n quan tr·ªçng ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫≠p tr√¨nh ƒë·ªì h·ªça v·ªõi Rust.</p>
</div>

## üìö Ki·∫øn Th·ª©c N·ªÅn T·∫£ng

### T·∫°i Sao C·∫ßn Th∆∞ Vi·ªán Windowing?

```mermaid
graph TD
    A[·ª®ng d·ª•ng WGPU] --> B[C·∫ßn c·ª≠a s·ªï ƒë·ªÉ hi·ªÉn th·ªã]
    B --> C[Th∆∞ vi·ªán Windowing]
    C --> D[winit - Cross Platform]
    C --> E[glutin - OpenGL Context]
    C --> F[SDL2 - Game Development]
    D --> G[H·ªó tr·ª£ raw-window-handle ‚úì]
    E --> H[H·ªó tr·ª£ raw-window-handle ‚úì]
    F --> I[H·ªó tr·ª£ raw-window-handle ‚úì]
```

<div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 my-4">
  <div className="flex">
    <div className="flex-shrink-0">
      <span className="text-2xl">‚ö†Ô∏è</span>
    </div>
    <div className="ml-3">
      <h3 className="text-lg font-medium text-yellow-800">L∆∞u √ù Quan Tr·ªçng</h3>
      <p className="text-yellow-700">B·∫•t k·ª≥ th∆∞ vi·ªán windowing n√†o b·∫°n ch·ªçn ƒë·ªÅu ph·∫£i h·ªó tr·ª£ crate <strong>raw-window-handle</strong> ƒë·ªÉ c√≥ th·ªÉ l√†m vi·ªác v·ªõi WGPU.</p>
    </div>
  </div>
</div>

## üîß Thi·∫øt L·∫≠p Dependencies

### B·∫£ng Dependencies C·∫ßn Thi·∫øt

| Crate | Version | M·ª•c ƒë√≠ch | B·∫Øt bu·ªôc |
|-------|---------|----------|----------|
| `anyhow` | "1.0" | X·ª≠ l√Ω l·ªói ƒë∆°n gi·∫£n | ‚úÖ |
| `winit` | "0.30" | T·∫°o v√† qu·∫£n l√Ω c·ª≠a s·ªï | ‚úÖ |
| `env_logger` | "0.10" | Logging cho debug | ‚úÖ |
| `log` | "0.4" | API logging | ‚úÖ |
| `wgpu` | "26.0.1" | Graphics API | ‚úÖ |
| `pollster` | "0.3" | Async runtime ƒë∆°n gi·∫£n | ‚úÖ |

### C·∫•u h√¨nh Cargo.toml

```toml
[dependencies]
anyhow = "1.0"
winit = { version = "0.30", features = ["android-native-activity"] }
env_logger = "0.10"
log = "0.4"
wgpu = "26.0.1"
pollster = "0.3"

# C·∫ßn thi·∫øt cho WASM
[lib]
crate-type = ["cdylib", "rlib"]

# T·ªëi ∆∞u h√≥a cho release
[profile.release]
strip = true
```

<div className="bg-green-50 border-l-4 border-green-400 p-4 my-4">
  <div className="flex">
    <div className="flex-shrink-0">
      <span className="text-2xl">üí°</span>
    </div>
    <div className="ml-3">
      <h3 className="text-lg font-medium text-green-800">Tip: Resolver Version 2</h3>
      <p className="text-green-700">WGPU y√™u c·∫ßu Cargo's feature resolver version 2. N·∫øu b·∫°n s·ª≠ d·ª•ng Rust 2021 edition, ƒëi·ªÅu n√†y ƒë√£ ƒë∆∞·ª£c b·∫≠t m·∫∑c ƒë·ªãnh. V·ªõi 2018 edition, h√£y th√™m <code>resolver = "2"</code> v√†o Cargo.toml.</p>
    </div>
  </div>
</div>

## üèóÔ∏è Ki·∫øn Tr√∫c ·ª®ng D·ª•ng

### S∆° ƒê·ªì T·ªïng Quan

```mermaid
classDiagram
    class State {
        -window: Arc~Window~
        +new(window) State
        +resize(width, height)
        +render()
    }
    
    class App {
        -state: Option~State~
        -proxy: Option~EventLoopProxy~
        +new() App
    }
    
    class ApplicationHandler {
        <<interface>>
        +resumed(event_loop)
        +window_event(event_loop, event)
        +user_event(event_loop, event)
    }
    
    App ..|> ApplicationHandler
    App --> State
    State --> Window
```

## üìù Implement Code Chi Ti·∫øt

### B∆∞·ªõc 1: T·∫°o State Struct

```rust
use std::sync::Arc;
use winit::{
    application::ApplicationHandler, 
    event::*, 
    event_loop::{ActiveEventLoop, EventLoop}, 
    keyboard::{KeyCode, PhysicalKey}, 
    window::Window
};

#[cfg(target_arch = "wasm32")]
use wasm_bindgen::prelude::*;

pub struct State {
    window: Arc<Window>,
}

impl State {
    pub async fn new(window: Arc<Window>) -> anyhow::Result<Self> {
        Ok(Self { window })
    }

    pub fn resize(&mut self, _width: u32, _height: u32) {
        // S·∫Ω implement trong b√†i sau
    }
    
    pub fn render(&mut self) {
        self.window.request_redraw();
        // S·∫Ω c√≥ nhi·ªÅu logic render h∆°n trong b√†i sau
    }
}
```

### B∆∞·ªõc 2: T·∫°o App Struct

```rust
pub struct App {
    #[cfg(target_arch = "wasm32")]
    proxy: Option<winit::event_loop::EventLoopProxy<State>>,
    state: Option<State>,
}

impl App {
    pub fn new(
        #[cfg(target_arch = "wasm32")] 
        event_loop: &EventLoop<State>
    ) -> Self {
        #[cfg(target_arch = "wasm32")]
        let proxy = Some(event_loop.create_proxy());
        
        Self {
            state: None,
            #[cfg(target_arch = "wasm32")]
            proxy,
        }
    }
}
```

### B·∫£ng Ph√¢n T√≠ch C√°c Tr∆∞·ªùng c·ªßa App

| Tr∆∞·ªùng | Ki·ªÉu | M·ª•c ƒë√≠ch | Platform |
|--------|------|----------|----------|
| `state` | `Option<State>` | L∆∞u tr·ªØ state c·ªßa ·ª©ng d·ª•ng | All |
| `proxy` | `Option<EventLoopProxy<State>>` | G·ª≠i events async tr√™n web | WASM only |

## üîÑ Event Handling System

### S∆° ƒê·ªì Lu·ªìng Events

```mermaid
graph LR
    A[OS Events] --> B[Event Loop]
    B --> C{Event Type}
    C -->|Window| D[window_event]
    C -->|User| E[user_event]
    C -->|Lifecycle| F[resumed]
    
    D --> G[Process Window Events]
    E --> H[Process User Events]
    F --> I[Create Window & State]
    
    G --> J[Update State]
    H --> J
    I --> J
    J --> K[Render]
```

### Implement ApplicationHandler

#### 1. Resumed Method

```rust
impl ApplicationHandler<State> for App {
    fn resumed(&mut self, event_loop: &ActiveEventLoop) {
        #[allow(unused_mut)]
        let mut window_attributes = Window::default_attributes();

        #[cfg(target_arch = "wasm32")]
        {
            // C·∫•u h√¨nh cho web
            use wasm_bindgen::JsCast;
            use winit::platform::web::WindowAttributesExtWebSys;
            
            const CANVAS_ID: &str = "canvas";
            let window = wgpu::web_sys::window().unwrap_throw();
            let document = window.document().unwrap_throw();
            let canvas = document.get_element_by_id(CANVAS_ID).unwrap_throw();
            let html_canvas_element = canvas.unchecked_into();
            window_attributes = window_attributes.with_canvas(Some(html_canvas_element));
        }

        let window = Arc::new(event_loop.create_window(window_attributes).unwrap());

        #[cfg(not(target_arch = "wasm32"))]
        {
            // Native: S·ª≠ d·ª•ng pollster ƒë·ªÉ await
            self.state = Some(pollster::block_on(State::new(window)).unwrap());
        }

        #[cfg(target_arch = "wasm32")]
        {
            // Web: Ch·∫°y async v√† g·ª≠i k·∫øt qu·∫£ qua proxy
            if let Some(proxy) = self.proxy.take() {
                wasm_bindgen_futures::spawn_local(async move {
                    assert!(proxy
                        .send_event(State::new(window).await.expect("Unable to create state!"))
                        .is_ok())
                });
            }
        }
    }
}
```

### B·∫£ng So S√°nh Native vs Web

| Aspect | Native | Web |
|--------|--------|-----|
| Async Handling | `pollster::block_on()` | `wasm_bindgen_futures::spawn_local()` |
| Window Creation | Direct | Through Canvas Element |
| Event Communication | Direct | Through Proxy |
| Dependencies | Minimal | WASM-specific crates |

#### 2. User Event Method

```rust
impl ApplicationHandler<State> for App {
    fn user_event(&mut self, _event_loop: &ActiveEventLoop, mut event: State) {
        #[cfg(target_arch = "wasm32")]
        {
            event.window.request_redraw();
            event.resize(
                event.window.inner_size().width,
                event.window.inner_size().height,
            );
        }
        self.state = Some(event);
    }
}
```

#### 3. Window Event Method

```rust
impl ApplicationHandler<State> for App {
    fn window_event(
        &mut self,
        event_loop: &ActiveEventLoop,
        _window_id: winit::window::WindowId,
        event: WindowEvent,
    ) {
        let state = match &mut self.state {
            Some(state) => state,
            None => return,
        };

        match event {
            WindowEvent::CloseRequested => event_loop.exit(),
            WindowEvent::Resized(size) => state.resize(size.width, size.height),
            WindowEvent::RedrawRequested => state.render(),
            WindowEvent::KeyboardInput {
                event: KeyEvent {
                    physical_key: PhysicalKey::Code(code),
                    state: key_state,
                    ..
                },
                ..
            } => match (code, key_state.is_pressed()) {
                (KeyCode::Escape, true) => event_loop.exit(),
                _ => {}
            },
            _ => {}
        }
    }
}
```

### B·∫£ng C√°c Window Events Quan Tr·ªçng

| Event | M·ª•c ƒë√≠ch | Handler Method |
|-------|----------|----------------|
| `CloseRequested` | Ng∆∞·ªùi d√πng mu·ªën ƒë√≥ng c·ª≠a s·ªï | `event_loop.exit()` |
| `Resized` | C·ª≠a s·ªï thay ƒë·ªïi k√≠ch th∆∞·ªõc | `state.resize()` |
| `RedrawRequested` | C·∫ßn v·∫Ω l·∫°i frame | `state.render()` |
| `KeyboardInput` | Nh·∫≠n input t·ª´ b√†n ph√≠m | X·ª≠ l√Ω ph√≠m c·ª• th·ªÉ |

## üöÄ Ch·∫°y ·ª®ng D·ª•ng

### H√†m Run cho Native

```rust
pub fn run() -> anyhow::Result<()> {
    #[cfg(not(target_arch = "wasm32"))]
    {
        env_logger::init();
    }
    #[cfg(target_arch = "wasm32")]
    {
        console_log::init_with_level(log::Level::Info).unwrap_throw();
    }

    let event_loop = EventLoop::with_user_event().build()?;
    let mut app = App::new(
        #[cfg(target_arch = "wasm32")]
        &event_loop,
    );
    event_loop.run_app(&mut app)?;

    Ok(())
}
```

<div className="bg-red-50 border-l-4 border-red-400 p-4 my-4">
  <div className="flex">
    <div className="flex-shrink-0">
      <span className="text-2xl">üö®</span>
    </div>
    <div className="ml-3">
      <h3 className="text-lg font-medium text-red-800">Quan Tr·ªçng: env_logger</h3>
      <p className="text-red-700">Lu√¥n lu√¥n g·ªçi <code>env_logger::init()</code> tr∆∞·ªõc khi s·ª≠ d·ª•ng WGPU. N·∫øu kh√¥ng, khi WGPU g·∫∑p l·ªói, b·∫°n s·∫Ω ch·ªâ th·∫•y th√¥ng b√°o generic m√† kh√¥ng bi·∫øt l·ªói th·ª±c s·ª± l√† g√¨!</p>
    </div>
  </div>
</div>

## üåê H·ªó Tr·ª£ Web Assembly

### Dependencies cho WASM

```toml
[target.'cfg(target_arch = "wasm32")'.dependencies]
console_error_panic_hook = "0.1.6"
console_log = "1.0"
wgpu = { version = "26.0.1", features = ["webgl"]}
wasm-bindgen = "0.2"
wasm-bindgen-futures = "0.4.30"
web-sys = { version = "0.3", features = [
    "Document",
    "Window", 
    "Element",
]}
```

### B·∫£ng Ph√¢n T√≠ch WASM Dependencies

| Crate | M·ª•c ƒë√≠ch | T·∫ßm quan tr·ªçng |
|-------|----------|----------------|
| `console_error_panic_hook` | Hi·ªÉn th·ªã panic tr√™n browser console | Cao |
| `console_log` | Logging tr√™n browser | Cao |
| `wasm-bindgen` | Bridge Rust-JavaScript | C·ª±c cao |
| `wasm-bindgen-futures` | Async support cho WASM | Cao |
| `web-sys` | Web APIs trong Rust | Cao |

### H√†m Entry Point cho Web

```rust
#[cfg(target_arch = "wasm32")]
#[wasm_bindgen(start)]
pub fn run_web() -> Result<(), wasm_bindgen::JsValue> {
    console_error_panic_hook::set_once();
    run().unwrap_throw();
    Ok(())
}
```

## üî® Build v√† Deploy

### Build Commands

```bash
# Native
cargo run

# WASM v·ªõi wasm-pack
wasm-pack build --target web

# WASM v·ªõi workspace
wasm-pack build game --target web
```

### HTML Template cho WASM

```html
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WGPU Tutorial</title>
    <style>
        * { padding: 0; margin: 0; }
        canvas { 
            background-color: black; 
            width: 100%; 
            height: 100vh; 
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script type="module">
        import init from "./pkg/your_crate_name.js";
        init().then(() => {
            console.log("WASM Loaded Successfully!");
        });
    </script>
</body>
</html>
```

## üìä Workflow T·ªïng Quan

```mermaid
flowchart TD
    A[Kh·ªüi t·∫°o Project] --> B[C·∫•u h√¨nh Cargo.toml]
    B --> C[Implement State Struct]
    C --> D[Implement App Struct]
    D --> E[Implement ApplicationHandler]
    E --> F[T·∫°o h√†m run]
    F --> G{Target Platform}
    
    G -->|Native| H[cargo run]
    G -->|WASM| I[wasm-pack build]
    
    H --> J[·ª®ng d·ª•ng ch·∫°y tr√™n desktop]
    I --> K[T·∫°o HTML file]
    K --> L[·ª®ng d·ª•ng ch·∫°y tr√™n browser]
    
    style A fill:#e1f5fe
    style J fill:#c8e6c9
    style L fill:#c8e6c9
```

## ‚úÖ Checklist Ho√†n Th√†nh

<div className="bg-gray-50 p-4 rounded-lg">
  <h3 className="text-lg font-semibold mb-3">Ki·ªÉm tra c√°c b∆∞·ªõc ƒë√£ ho√†n th√†nh:</h3>
  <ul className="space-y-2">
    <li className="flex items-center"><input type="checkbox" className="mr-2" /> C·∫•u h√¨nh Cargo.toml v·ªõi ƒë·ªß dependencies</li>
    <li className="flex items-center"><input type="checkbox" className="mr-2" /> T·∫°o State struct v·ªõi window</li>
    <li className="flex items-center"><input type="checkbox" className="mr-2" /> Implement App struct v·ªõi ApplicationHandler</li>
    <li className="flex items-center"><input type="checkbox" className="mr-2" /> X·ª≠ l√Ω window events (close, resize, keyboard)</li>
    <li className="flex items-center"><input type="checkbox" className="mr-2" /> Thi·∫øt l·∫≠p logging v·ªõi env_logger</li>
    <li className="flex items-center"><input type="checkbox" className="mr-2" /> Test ch·∫°y tr√™n native</li>
    <li className="flex items-center"><input type="checkbox" className="mr-2" /> C·∫•u h√¨nh WASM dependencies (optional)</li>
    <li className="flex items-center"><input type="checkbox" className="mr-2" /> Test ch·∫°y tr√™n browser (optional)</li>
  </ul>
</div>

## üéì T·ªïng K·∫øt

Trong b√†i h·ªçc n√†y, ch√∫ng ta ƒë√£:

1. **Thi·∫øt l·∫≠p** m√¥i tr∆∞·ªùng ph√°t tri·ªÉn v·ªõi c√°c dependencies c·∫ßn thi·∫øt
2. **T·∫°o** ki·∫øn tr√∫c c∆° b·∫£n v·ªõi State v√† App structs
3. **Implement** event handling system ho√†n ch·ªânh
4. **H·ªó tr·ª£** c·∫£ native v√† web platforms
5. **Hi·ªÉu** ƒë∆∞·ª£c workflow t·ª´ code ƒë·∫øn ·ª©ng d·ª•ng ch·∫°y ƒë∆∞·ª£c

<div className="bg-blue-50 border border-blue-200 rounded-lg p-6 mt-6">
  <h3 className="text-xl font-bold text-blue-800 mb-3">üöÄ B∆∞·ªõc Ti·∫øp Theo</h3>
  <p className="text-blue-700">Trong b√†i ti·∫øp theo, ch√∫ng ta s·∫Ω h·ªçc c√°ch t·∫°o <strong>Surface</strong> v√† b·∫Øt ƒë·∫ßu render graphics th·ª±c s·ª± v·ªõi WGPU. H√£y ƒë·∫£m b·∫£o code trong b√†i n√†y ch·∫°y t·ªët tr∆∞·ªõc khi ti·∫øp t·ª•c!</p>
</div>